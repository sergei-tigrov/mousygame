<!DOCTYPE html>
<html lang="ru">
<!-- üéÆ v3.7.0-LIVE: GitHub-only Leaderboard + Data Source Signature - FORCE DEPLOYED 2025-11-30 -->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no, maximum-scale=1.0, minimum-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="–ú—ã—à–∏–Ω—ã–µ –ü—Ä—è—Ç–∫–∏">
    <meta name="theme-color" content="#FF6B6B">
    <title>üê≠ –ú–´–®–ò–ù–´–ï –ü–†–Ø–¢–ö–ò - CROSS-PLATFORM</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-touch-callout: none; -webkit-user-select: none; user-select: none; }
        html, body { width: 100%; height: 100%; overflow: hidden; }
        body {
            font-family: 'Arial', 'Helvetica', 'Segoe UI', -apple-system, sans-serif;
            background: linear-gradient(135deg, #FF6B6B 0%, #FFD93D 50%, #6BCB77 100%);
            display: flex; justify-content: center; align-items: center;
            min-height: 100vh; color: white;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        .container {
            width: 100%; height: 100%;
            display: flex; justify-content: center; align-items: center;
            position: relative;
            overflow: hidden;
            -webkit-text-size-adjust: 100%;
        }
        #gameCanvas {
            border: 2px solid #FFD93D;
            background: linear-gradient(135deg, #FFE66D 0%, #F4F4F4 50%, #A8E6CF 100%);
            box-shadow: 0 0 40px rgba(255, 107, 107, 0.6), inset 0 0 20px rgba(255, 255, 255, 0.3);
            cursor: crosshair;
            display: block;
            image-rendering: crisp-edges;
            image-rendering: -webkit-optimize-contrast;
            -ms-touch-action: none;
            touch-action: none;
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }
        /* Safari/iOS fixes */
        #gameCanvas {
            -webkit-user-select: none;
            -webkit-touch-callout: none;
        }
        .ui-overlay {
            position: absolute; width: 100%; height: 100%;
            display: flex; flex-direction: column; pointer-events: none;
        }
        .ui-top {
            display: flex; justify-content: space-between; align-items: center;
            padding: 10px; font-size: 14px; font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5); gap: 5px; flex-wrap: wrap;
        }
        .ui-bottom {
            padding: 10px; text-align: center; font-size: 12px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }
        .stat {
            padding: 8px 12px;
            background: linear-gradient(135deg, rgba(255, 107, 107, 0.8), rgba(255, 217, 61, 0.8));
            border-radius: 8px; border: 1px solid rgba(255, 255, 255, 0.6);
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3); font-weight: bold;
            font-size: 12px;
        }
        /* ‚≠ê v3.6.0: Audio toggle button (bottom right) */
        .audio-toggle-btn {
            background: linear-gradient(135deg, rgba(70, 130, 180, 0.9), rgba(100, 200, 255, 0.9));
            border: 2px solid rgba(255, 255, 255, 0.8);
            border-radius: 50%;
            width: 48px;
            height: 48px;
            padding: 0;
            margin-left: auto;
            margin-right: 10px;
            font-size: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.4);
            pointer-events: auto;
            flex-shrink: 0;
            -webkit-tap-highlight-color: transparent;
            -webkit-appearance: none;
            touch-action: manipulation;
        }
        .audio-toggle-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 16px rgba(100, 200, 255, 0.6);
            background: linear-gradient(135deg, rgba(80, 150, 200, 0.95), rgba(120, 220, 255, 0.95));
        }
        .audio-toggle-btn:active {
            transform: scale(0.95);
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
        }
        .menu-screen, .pause-screen, .level-complete-screen, .game-over-screen {
            position: absolute; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.95); display: none;
            flex-direction: column; justify-content: center; align-items: center;
            z-index: 100; pointer-events: all;
            overflow-y: auto;
        }
        .menu-screen.active, .pause-screen.active, .level-complete-screen.active, .game-over-screen.active {
            display: flex;
        }
        .menu-content { text-align: center; animation: slideIn 0.5s ease-out; padding: 20px; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(-30px); } to { opacity: 1; transform: translateY(0); } }
        .title { font-size: clamp(28px, 8vw, 56px); margin-bottom: 15px; text-shadow: 3px 3px 6px rgba(0, 0, 0, 0.7); }
        .menu-content p { font-size: clamp(14px, 4vw, 18px); margin: 8px 0; opacity: 0.95; }
        .button {
            background: linear-gradient(135deg, #FF6B6B 0%, #FFD93D 100%);
            color: white;
            border: 2px solid white;
            padding: 16px 32px;
            font-size: clamp(14px, 4vw, 18px);
            border-radius: 12px;
            cursor: pointer;
            margin: 12px 8px;
            transition: all 0.2s ease;
            font-weight: bold;
            -webkit-appearance: none;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
            /* –ö–†–ò–¢–ò–ß–ù–û –¥–ª—è –º–æ–±–∏–ª—è */
            min-height: 52px;
            min-width: 120px;
            display: inline-block;
            text-align: center;
            vertical-align: middle;
            pointer-events: auto;
            z-index: 101;
            position: relative;
            line-height: 1.2;
            white-space: nowrap;
        }
        .button:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 24px rgba(255, 255, 255, 0.6);
        }
        .button:active {
            transform: scale(0.95);
            background: linear-gradient(135deg, #FF5252 0%, #FFC300 100%);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }
        .button:focus {
            outline: 3px solid rgba(255, 255, 255, 0.8);
            outline-offset: 2px;
        }
        /* Mobile touch optimization */
        @supports (touch-action: auto) {
            .button {
                -webkit-touch-callout: none;
            }
        }
        .hint { font-size: clamp(12px, 3vw, 14px); opacity: 0.75; margin-top: 15px; line-height: 1.4; }

        /* Virtual Controls - Hidden by default, shown on mobile landscape */
        #virtualControls {
            display: none !important;
            position: absolute;
            bottom: 10px;
            left: 10px;
            right: 10px;
            z-index: 50;
        }
        .control-group {
            display: grid;
            grid-template-columns: 60px 60px 60px;
            gap: 5px;
            margin-bottom: 8px;
        }
        .control-btn {
            width: 50px;
            height: 50px;
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.4);
            border-radius: 8px;
            color: white;
            font-weight: bold;
            font-size: 20px;
            cursor: pointer;
            touch-action: manipulation;
            -webkit-user-select: none;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }
        .control-btn:active {
            background: rgba(255, 255, 255, 0.4);
            border-color: rgba(255, 255, 255, 0.6);
        }

        @keyframes tipFade {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Responsive design for tablets */
        @media (max-width: 1024px) {
            .ui-top { padding: 8px; font-size: 12px; gap: 4px; }
            .ui-bottom { padding: 8px; font-size: 11px; }
            .stat { padding: 6px 10px; font-size: 11px; }
        }

        /* Responsive design for mobile phones */
        @media (max-width: 768px) {
            #gameCanvas { border: 1px solid #FFD93D; }
            .ui-top { padding: 6px; font-size: 11px; gap: 3px; }
            .ui-bottom { padding: 6px; font-size: 10px; }
            .stat { padding: 5px 8px; font-size: 10px; border-radius: 6px; }
            .button { padding: 8px 16px; font-size: clamp(12px, 3.5vw, 14px); margin: 4px; }
            .title { font-size: clamp(24px, 7vw, 40px); margin-bottom: 10px; }
            .menu-content p { font-size: clamp(12px, 3vw, 14px); margin: 6px 0; }
            #virtualControls { display: flex; flex-direction: column; }
        }

        /* Small phones */
        @media (max-width: 480px) {
            #gameCanvas { border: 1px solid #FFD93D; }
            .ui-top { padding: 4px; font-size: 10px; gap: 2px; flex-direction: column; align-items: flex-start; }
            .ui-bottom { padding: 4px; font-size: 9px; }
            .stat { padding: 4px 6px; font-size: 9px; border-radius: 4px; }
            .button { padding: 8px 12px; font-size: clamp(12px, 3vw, 13px); margin: 3px; }
            .title { font-size: clamp(20px, 6vw, 32px); margin-bottom: 8px; }
            .menu-content p { font-size: clamp(11px, 2.5vw, 12px); margin: 4px 0; }
            .menu-content { padding: 15px; }
            .hint { font-size: clamp(10px, 2vw, 11px); }
            .control-group { grid-template-columns: 50px 50px 50px; }
            .control-btn { width: 45px; height: 45px; font-size: 18px; }
        }

        /* Landscape mode */
        @media (max-height: 500px) and (orientation: landscape) {
            .ui-top { padding: 4px; font-size: 10px; }
            .ui-bottom { padding: 4px; font-size: 9px; }
            .stat { padding: 4px 6px; font-size: 9px; }
        }

        /* Safe area for notched devices */
        @supports (padding: max(0px)) {
            body {
                padding-left: env(safe-area-inset-left);
                padding-right: env(safe-area-inset-right);
            }
        }

        /* ‚≠ê MOBILE LANDSCAPE OPTIMIZATION (v2.8.1) - WORKS ON IPHONE! */
        @media (orientation: landscape) and (max-height: 500px) {
            body, html, .container {
                width: 100vw;
                height: 100vh;
                max-width: 100vw;
                max-height: 100vh;
                overflow: hidden;
                padding: 0;
                margin: 0;
            }

            .container {
                flex-direction: row;
                padding: 0;
            }

            #gameCanvas {
                border: none;
                box-shadow: none;
                margin: 0;
                padding: 0;
                flex: 1;
                height: 100%;
                max-width: 100%;
                max-height: 100%;
            }

            /* Hide desktop UI overlays on mobile landscape */
            .ui-overlay {
                display: none !important;
            }

            #controls {
                display: none !important;
            }

            /* Mobile landscape menu screens */
            .menu-screen, .pause-screen, .level-complete-screen, .game-over-screen {
                position: fixed;
                width: 100vw;
                height: 100vh;
                z-index: 1000;
                overflow-y: auto;
                background: rgba(0, 0, 0, 0.98);
            }

            .menu-content {
                padding: 10px;
                max-width: 90vw;
            }

            .title {
                font-size: clamp(20px, 5vw, 32px);
                margin-bottom: 10px;
            }

            .button {
                padding: 10px 16px;
                font-size: clamp(12px, 3vw, 16px);
                min-height: 44px;
                min-width: 90px;
                margin: 6px 4px;
            }

            /* ‚≠ê v2.8.1: VISIBLE MOBILE CONTROLS */
            #virtualControls {
                display: flex !important;
                position: fixed;
                top: 0;
                left: 0;
                width: 100vw;
                height: 100vh;
                z-index: 998;
                flex-direction: row;
                justify-content: space-between;
                align-items: flex-end;
                padding: max(5px, env(safe-area-inset-top)) max(5px, env(safe-area-inset-right)) max(5px, env(safe-area-inset-bottom)) max(5px, env(safe-area-inset-left));
                gap: 8px;
                pointer-events: none;
                background: transparent;
            }

            /* D-PAD CONTAINER - LEFT SIDE */
            .dpad-container {
                display: flex;
                flex-direction: column;
                gap: 3px;
                pointer-events: auto;
                padding-bottom: 5px;
            }

            .dpad-row {
                display: flex;
                gap: 3px;
                justify-content: center;
            }

            .dpad-center {
                width: 40px;
                height: 40px;
            }

            /* D-PAD BUTTONS - SMALLER FOR MOBILE */
            .dpad-btn {
                width: 40px;
                height: 40px;
                padding: 0;
                border: 2px solid rgba(255, 255, 255, 0.8);
                border-radius: 6px;
                background: linear-gradient(135deg, rgba(255, 107, 107, 0.9), rgba(255, 107, 107, 0.7));
                color: white;
                font-size: 16px;
                font-weight: bold;
                cursor: pointer;
                touch-action: manipulation;
                transition: all 0.08s ease;
                box-shadow: 0 3px 8px rgba(0, 0, 0, 0.5);
                display: flex;
                align-items: center;
                justify-content: center;
                -webkit-user-select: none;
                user-select: none;
                -webkit-touch-callout: none;
                outline: none;
                min-height: 40px;
                min-width: 40px;
            }

            .dpad-btn:active {
                transform: scale(0.95);
                background: linear-gradient(135deg, rgba(255, 60, 60, 1), rgba(255, 60, 60, 0.8));
                box-shadow: 0 1px 4px rgba(0, 0, 0, 0.6);
            }

            /* ACTION BUTTONS - RIGHT SIDE (2x2 GRID) - SMALLER */
            .action-buttons {
                display: grid;
                grid-template-columns: 45px 45px;
                gap: 5px;
                pointer-events: auto;
                padding-bottom: 5px;
            }

            .action-btn {
                width: 45px;
                height: 45px;
                padding: 0;
                border: 2px solid rgba(255, 255, 255, 0.8);
                border-radius: 6px;
                font-size: 18px;
                font-weight: bold;
                cursor: pointer;
                touch-action: manipulation;
                transition: all 0.08s ease;
                box-shadow: 0 3px 8px rgba(0, 0, 0, 0.5);
                display: flex;
                align-items: center;
                justify-content: center;
                -webkit-user-select: none;
                user-select: none;
                -webkit-touch-callout: none;
                outline: none;
                min-height: 45px;
                min-width: 45px;
            }

            #btn-space {
                background: linear-gradient(135deg, rgba(100, 150, 255, 0.9), rgba(100, 150, 255, 0.7));
            }

            #btn-tab {
                background: linear-gradient(135deg, rgba(150, 100, 255, 0.9), rgba(150, 100, 255, 0.7));
            }

            #btn-shift {
                background: linear-gradient(135deg, rgba(255, 200, 100, 0.9), rgba(255, 200, 100, 0.7));
            }

            #btn-e {
                background: linear-gradient(135deg, rgba(107, 203, 119, 0.9), rgba(107, 203, 119, 0.7));
            }

            .action-btn:active {
                transform: scale(0.95);
                box-shadow: 0 1px 4px rgba(0, 0, 0, 0.6);
            }

            /* Mobile landscape specific - hide hint on small screens */
            .hint {
                display: none;
            }

            .menu-content p {
                font-size: clamp(12px, 3vw, 14px);
                margin: 4px 0;
            }

            /* Status bars for mobile */
            #statsPanel {
                grid-template-columns: 1fr 1fr !important;
                gap: 8px !important;
            }

            /* Prevent double tap zoom on mobile */
            input, button, select, textarea {
                touch-action: manipulation;
            }
        }

        /* Mobile portrait - show orientation message */
        @media (max-width: 768px) and (orientation: portrait) {
            #orientationPrompt {
                display: flex !important;
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                z-index: 10000;
                background: linear-gradient(135deg, #FF6B6B 0%, #FFD93D 100%);
                flex-direction: column;
                justify-content: center;
                align-items: center;
                text-align: center;
                padding: 20px;
            }

            #orientationPrompt h1 {
                font-size: 32px;
                color: white;
                margin-bottom: 20px;
                text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            }

            #orientationPrompt p {
                font-size: 18px;
                color: white;
                margin: 10px 0;
            }

            #orientationPrompt .phone-icon {
                font-size: 80px;
                margin: 20px 0;
            }
        }
    </style>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%.3em font-size=75>üê≠</text></svg>">
</head>
<body>
    <div class="container">
        <canvas id="gameCanvas"></canvas>
        <!-- ‚≠ê v2.8.0: –ü–†–û–°–¢–û–ô –ù–ê–î–ï–ñ–ù–´–ô D-PAD + ACTION BUTTONS -->
        <div id="virtualControls" class="mobile-controls-container">
            <!-- –õ–ï–í–ê–Ø –°–¢–û–†–û–ù–ê: –ü–†–û–°–¢–û–ô D-PAD (4 –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è) -->
            <div class="dpad-container">
                <!-- UP -->
                <button class="dpad-btn dpad-up" id="btn-up" data-key="ArrowUp" title="–í–í–ï–†–•">‚ñ≤</button>

                <!-- LEFT, CENTER SPACER, RIGHT -->
                <div class="dpad-row">
                    <button class="dpad-btn dpad-left" id="btn-left" data-key="ArrowLeft" title="–í–õ–ï–í–û">‚óÄ</button>
                    <div class="dpad-center"></div>
                    <button class="dpad-btn dpad-right" id="btn-right" data-key="ArrowRight" title="–í–ü–†–ê–í–û">‚ñ∂</button>
                </div>

                <!-- DOWN -->
                <button class="dpad-btn dpad-down" id="btn-down" data-key="ArrowDown" title="–í–ù–ò–ó">‚ñº</button>
            </div>

            <!-- –ü–†–ê–í–ê–Ø –°–¢–û–†–û–ù–ê: ACTION BUTTONS (2x2 GRID) -->
            <div class="action-buttons">
                <button class="action-btn" id="btn-space" data-key="Space" title="–ü–ê–£–ó–ê">‚è∏Ô∏è</button>
                <button class="action-btn" id="btn-tab" data-key="Tab" title="–ú–´–®–¨">üê≠</button>
                <button class="action-btn" id="btn-shift" data-key="Shift" title="–°–ü–†–ò–ù–¢">‚ö°</button>
                <button class="action-btn" id="btn-e" data-key="e" title="–ù–û–†–ö–ê">üè†</button>
            </div>
        </div>
        <div class="ui-overlay">
            <div class="ui-top">
                <div class="stat">üê≠ <span id="miceCount">0</span> HP: <span id="miceHP">0</span></div>
                <div class="stat">üßÄ <span id="cheeseCount">0</span>/<span id="totalCheese">0</span></div>
                <div class="stat">‚≠ê <span id="levelNumber">1</span></div>
                <div class="stat">‚ö° <span id="stamina">100</span>%</div>
                <div class="stat">FPS: <span id="fps">60</span></div>
            </div>
            <div style="flex: 1;"></div>
            <div class="ui-bottom" id="controls" style="display: flex; justify-content: space-between; align-items: center;">
                <span>WASD/‚Üë‚Üì‚Üê‚Üí –¥–≤–∏–∂–µ–Ω–∏–µ | SHIFT —Å–ø—Ä–∏–Ω—Ç | –ü–†–û–ë–ï–õ –ø–∞—É–∑–∞ | TAB –º—ã—à—å | E –Ω–æ—Ä–∫–∞</span>
                <!-- ‚≠ê v3.6.0: Audio toggle button in bottom right -->
                <button id="audioToggleBtn" class="audio-toggle-btn" onclick="toggleAudio()" title="–í–∫–ª—é—á–∏—Ç—å/–≤—ã–∫–ª—é—á–∏—Ç—å –∑–≤—É–∫">üîä</button>
            </div>
        </div>

        <div class="menu-screen active" id="menuScreen">
            <div class="menu-content">
                <div class="title">üê≠ –ú–´–®–ò–ù–´–ï –ü–†–Ø–¢–ö–ò üëÄ</div>
                <p>–ü–æ–º–æ–≥–∏ –º—ã—à–∫–∞–º —Å–ø—Ä—è—Ç–∞—Ç—å—Å—è –æ—Ç –∫–æ—à–µ–∫!</p>
                <p style="font-size: 11px; opacity: 0.6; margin-bottom: 10px;">–í–µ—Ä—Å–∏—è <span id="versionDisplay">3.6.0</span></p>
                <button class="button" onclick="startGame()">‚ñ∂Ô∏è –ù–ê–ß–ê–¢–¨ –ò–ì–†–£</button>
                <button class="button" onclick="showLeaderboardFromMenu()" style="margin-top: 10px;">üèÜ –†–ï–ô–¢–ò–ù–ì</button>
                <div class="hint" id="menuTip" style="
                    background: rgba(255, 255, 255, 0.1);
                    padding: 15px;
                    border-radius: 10px;
                    margin-top: 20px;
                    border-left: 4px solid #FFD93D;
                    min-height: 60px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    text-align: center;
                    animation: tipFade 0.5s ease-in;
                ">
                    –ó–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è...
                </div>
                <button class="button" onclick="rotateTip()" style="
                    background: transparent;
                    border: 1px solid #FFD93D;
                    padding: 8px 16px;
                    margin-top: 10px;
                    font-size: 12px;
                ">‚Üª –î–†–£–ì–û–ô –°–û–í–ï–¢</button>
            </div>
        </div>

        <div class="pause-screen" id="pauseScreen">
            <div class="menu-content">
                <div class="title">‚è∏Ô∏è –ü–ê–£–ó–ê</div>
                <button class="button" onclick="resumeGame()">‚ñ∂Ô∏è –ü–†–û–î–û–õ–ñ–ò–¢–¨</button>
                <button class="button" onclick="menuGame()">üè† –í –ú–ï–ù–Æ</button>
            </div>
        </div>

        <div class="level-complete-screen" id="levelCompleteScreen">
            <div class="menu-content">
                <div class="title">üéâ –£–†–û–í–ï–ù–¨ –ü–†–û–ô–î–ï–ù!</div>
                <p id="levelCompleteText"></p>
                <button class="button" onclick="nextLevel()">‚ñ∂Ô∏è –°–õ–ï–î–£–Æ–©–ò–ô –£–†–û–í–ï–ù–¨</button>
            </div>
        </div>

        <div class="game-over-screen" id="gameOverScreen">
            <div class="menu-content">
                <div class="title">üíÄ –ò–ì–†–ê –û–ö–û–ù–ß–ï–ù–ê</div>
                <div style="
                    background: rgba(0, 0, 0, 0.3);
                    padding: 20px;
                    border-radius: 15px;
                    margin: 15px 0;
                    border-left: 4px solid #FF5722;
                ">
                    <p id="gameOverText" style="margin: 0;"></p>
                </div>
                <div id="statsPanel" style="
                    display: grid;
                    grid-template-columns: 1fr 1fr;
                    gap: 10px;
                    margin: 15px 0;
                ">
                </div>
                <div id="scoreInputPanel" style="display: none;">
                    <input type="text" id="playerName" placeholder="–í–≤–µ–¥–∏ —Å–≤–æ—ë –∏–º—è..." maxlength="20" style="
                        padding: 12px;
                        font-size: 18px;
                        border: 2px solid #FFD93D;
                        border-radius: 10px;
                        margin: 15px 0;
                        text-align: center;
                        background: rgba(255, 255, 255, 0.9);
                        color: #333;
                    ">
                    <div style="display: flex; gap: 10px; justify-content: center;">
                        <button class="button" onclick="saveScore()">üíæ –°–û–•–†–ê–ù–ò–¢–¨</button>
                        <button class="button" onclick="skipScoreSave()">‚è≠Ô∏è –ü–†–û–ü–£–°–¢–ò–¢–¨</button>
                    </div>
                </div>
                <button class="button" id="leaderboardBtn" onclick="showLeaderboard()" style="margin-top: 10px;">‚≠ê –†–ï–ô–¢–ò–ù–ì</button>
                <button class="button" onclick="menuGame()">üè† –í –ú–ï–ù–Æ</button>
            </div>
        </div>

        <div class="game-over-screen" id="leaderboardScreen" style="display: none;">
            <div class="menu-content">
                <div class="title">‚≠ê –¢–ê–ë–õ–ò–¶–ê –õ–ò–î–ï–†–û–í</div>
                <div id="leaderboardContent" style="
                    background: rgba(0, 0, 0, 0.3);
                    padding: 20px;
                    border-radius: 15px;
                    margin: 20px 0;
                    max-height: 400px;
                    overflow-y: auto;
                    text-align: left;
                "></div>
                <div style="display: flex; gap: 10px; justify-content: center;">
                    <button class="button" onclick="hideLeaderboard()">‚Üê –ù–ê–ó–ê–î</button>
                    <button class="button" onclick="menuGame()">üè† –í –ú–ï–ù–Æ</button>
                </div>
            </div>
        </div>

        <!-- ‚≠ê MOBILE ORIENTATION PROMPT (v2.6.0) -->
        <div id="orientationPrompt" style="display: none;">
            <div class="phone-icon">üì±</div>
            <h1>–ü–æ–≤–µ—Ä–Ω–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ!</h1>
            <p>–≠—Ç–∞ –∏–≥—Ä–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –ª—É—á—à–µ –≤—Å–µ–≥–æ –≤ –ª–∞–Ω–¥—à–∞—Ñ—Ç–Ω–æ–π –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏–∏</p>
            <p style="font-size: 14px; opacity: 0.8; margin-top: 20px;">–ü–æ–≤–µ—Ä–Ω–∏ —Ç–µ–ª–µ—Ñ–æ–Ω –Ω–∞ 90¬∞</p>
        </div>
    </div>

        <!-- ‚≠ê v3.6.0: –°–∫—Ä—ã—Ç—ã–π audio —ç–ª–µ–º–µ–Ω—Ç –¥–ª—è —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ Safari iOS Web Audio API -->
        <audio id="silentAudio" style="display: none;">
            <source src="data:audio/wav;base64,UklGRiYAAABXQVZFZm10IBAAAAABAAEAQB8AAAB9AAACABAAZGF0YQIAAAAAAA==" type="audio/wav">
        </audio>

    <script>
        // ==================== –í–ï–†–°–ò–Ø –ò–ì–†–´ ====================
        const GAME_VERSION = '3.7.0-LIVE'; // ‚≠ê GitHub-only Leaderboard - Removed localStorage fallback, single source of truth - FORCE DEPLOYED

        // ==================== CROSS-PLATFORM & MOBILE SUPPORT ====================
        const isTouchDevice = () => (('ontouchstart' in window) || (navigator.maxTouchPoints > 0) || (navigator.msMaxTouchPoints > 0));
        const isMobileDevice = () => /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        const isIOSSafari = () => /Safari/.test(navigator.userAgent) && /iPhone|iPad|iPod/.test(navigator.userAgent) && !window.MSStream;

        // ‚≠ê v3.6.0: DEVICE TYPE DEFINITION - –¥–ª—è —è–≤–Ω–æ–π –∏–∑–æ–ª—è—Ü–∏–∏ –º–æ–±–∏–ª—å–Ω–æ–π/–¥–µ—Å–∫—Ç–æ–ø–Ω–æ–π –ª–æ–≥–∏–∫–∏
        const DEVICE_TYPE = {
            DESKTOP: 'desktop',
            MOBILE: 'mobile'
        };

        // ‚úÖ –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –æ–¥–∏–Ω —Ä–∞–∑ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        const CURRENT_DEVICE = isMobileDevice() || isTouchDevice() ? DEVICE_TYPE.MOBILE : DEVICE_TYPE.DESKTOP;

        // ‚≠ê v3.6.0: UNIFIED DOM ELEMENT CACHE - –ò–∑–±–µ–≥–∞–µ–º 62+ getElementById calls
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è –æ–¥–∏–Ω —Ä–∞–∑ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        const DOM = {};
        function initDOMCache() {
            DOM.gameCanvas = document.getElementById('gameCanvas');
            DOM.canvas = DOM.gameCanvas;  // –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–æ–µ –∏–º—è –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
            DOM.gameOverScreen = document.getElementById('gameOverScreen');
            DOM.pauseScreen = document.getElementById('pauseScreen');
            DOM.levelCompleteScreen = document.getElementById('levelCompleteScreen');
            DOM.menuScreen = document.getElementById('menuScreen');
            DOM.virtualControls = document.getElementById('virtualControls');
            DOM.playerName = document.getElementById('playerName');
            DOM.leaderboardScreen = document.getElementById('leaderboardScreen');
            DOM.leaderboardContent = document.getElementById('leaderboardContent');
            DOM.scoreInputPanel = document.getElementById('scoreInputPanel');
            DOM.levelNumber = document.getElementById('levelNumber');
            DOM.cheeseCount = document.getElementById('cheeseCount');
            DOM.totalCheese = document.getElementById('totalCheese');
            DOM.miceCount = document.getElementById('miceCount');
            DOM.miceHP = document.getElementById('miceHP');
            DOM.stamina = document.getElementById('stamina');
            DOM.fps = document.getElementById('fps');
            DOM.controls = document.getElementById('controls');
            DOM.controllerIndicator = document.getElementById('controllerIndicator');
            DOM.versionDisplay = document.getElementById('versionDisplay');
            DOM.statsPanel = document.getElementById('statsPanel');
            DOM.silentAudio = document.getElementById('silentAudio');
            DOM.orientationPrompt = document.getElementById('orientationPrompt');
            DOM.gameOverText = document.getElementById('gameOverText');
            DOM.levelCompleteText = document.getElementById('levelCompleteText');
            DOM.menuTip = document.getElementById('menuTip');
            DOM.audioToggleBtn = document.getElementById('audioToggleBtn');
            DOM.viewportMeta = document.querySelector('meta[name="viewport"]');
        }
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∫—ç—à —Ç–æ–ª—å–∫–æ –∫–æ–≥–¥–∞ DOM –≥–æ—Ç–æ–≤
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initDOMCache);
        } else {
            initDOMCache();
        }

        let devicePixelRatio = window.devicePixelRatio || 1;
        let lastOrientationCheck = window.innerWidth > window.innerHeight ? 'landscape' : 'portrait';

        // ==================== –†–ï–ù–î–ï–†–ò–ù–ì –≠–ú–û–î–ó–ò - –†–ê–ë–û–¢–ê–ï–¢ –ù–ê –í–°–ï–• –ë–†–ê–£–ó–ï–†–ê–• ====================
        // –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π font stack –¥–ª—è Safari, Chrome, Firefox, Edge –∏ –º–æ–±–∏–ª—å–Ω—ã—Ö –±—Ä–∞—É–∑–µ—Ä–æ–≤
        function drawEmoji(ctx, emoji, x, y, fontSize) {
            ctx.save();
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillStyle = '#000000';

            // Safari —Ç—Ä–µ–±—É–µ—Ç —è–≤–Ω–æ–≥–æ —É–∫–∞–∑–∞–Ω–∏—è —Ü–≤–µ—Ç–Ω–æ–≥–æ —ç–º–æ–¥–∑–∏ —à—Ä–∏—Ñ—Ç–∞
            // –ü–æ—Ä—è–¥–æ–∫ –≤–∞–∂–µ–Ω: —Å–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º Apple Color Emoji, –ø–æ—Ç–æ–º –æ—Å—Ç–∞–ª—å–Ω—ã–µ
            const fonts = [
                `${fontSize}px "Apple Color Emoji"`,
                `${fontSize}px "Segoe UI Emoji"`,
                `${fontSize}px "Noto Color Emoji"`,
                `${fontSize}px Arial`,
                `${fontSize}px sans-serif`
            ];

            let rendered = false;
            for (let fontFamily of fonts) {
                try {
                    ctx.font = fontFamily;
                    ctx.fillText(emoji, x, y);
                    rendered = true;
                    break;
                } catch (e) {
                    // –ü—ã—Ç–∞–µ–º—Å—è —Å–ª–µ–¥—É—é—â–∏–π —à—Ä–∏—Ñ—Ç
                    continue;
                }
            }

            if (!rendered) {
                console.log('‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç—Ä–µ–Ω–¥–µ—Ä–∏—Ç—å —ç–º–æ–¥–∑–∏:', emoji);
            }

            ctx.restore();
        }

        function getOptimalCanvasSize() {
            const width = window.innerWidth * 0.98;
            const height = window.innerHeight * 0.88;
            const maxWidth = 2400;
            const maxHeight = 1800;
            return {
                width: Math.min(width, maxWidth),
                height: Math.min(height, maxHeight),
                dpr: devicePixelRatio
            };
        }

        // ==================== –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ====================
        const CONFIG = {
            friction: 0.82,
            mouseSpeed: 1.2,           // ‚≠ê v3.6.0: –ü–æ–Ω–∏–∂–µ–Ω–∞ –±–∞–∑–æ–≤–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å (–±—ã–ª–æ 1.5)
            mouseSprintSpeed: 2.0,     // ‚≠ê v3.6.0: –ü–æ–Ω–∏–∂–µ–Ω–∞ —Å–∫–æ—Ä–æ—Å—Ç—å —Å–ø—Ä–∏–Ω—Ç–∞ (–±—ã–ª–æ 2.8, –¥–µ–ª—å—Ç–∞: 1.67x)
            mouseMaxHP: 100,
            catDamage: 3,
            catSpeed: 2.0,
            catChaseSpeed: 2.8,
            catVisionRange: 220,
            catVisionAngle: 110,
            catHearingRange: 150,
            obstacleSize: 40,
            cheeseSize: 20,
            mouseSize: 25,
            catSize: 28,
            maxStamina: 100,
            staminaDecayRun: 2.0,      // –ë—ã—Å—Ç—Ä–µ–µ –∏—Å—Ç–æ—â–∞–µ—Ç—Å—è —Å—Ç–∞–º–∏–Ω–∞ –Ω–∞ —Å–ø—Ä–∏–Ω—Ç–µ
            staminaRecovery: 0.6,      // –ú–µ–¥–ª–µ–Ω–Ω–µ–µ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è
            noiseDecay: 2,
            healingSpeed: 0.5,
            burrowRadius: 35,
        };

        function getLevelConfig(level) {
            // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –≤—Ä–∞–≥–æ–≤ —á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ –ª–∞–≥–∞ –Ω–∞ –≤—ã—Å–æ–∫–∏—Ö —É—Ä–æ–≤–Ω—è—Ö
            const maxCats = 8;
            const maxMice = 8;

            const base = {
                mice: Math.min(1 + Math.floor((level - 1) / 1), maxMice),
                cats: Math.min(1 + Math.floor((level - 1) / 1), maxCats),
                cheese: 3 + (level - 1) * 2,
                obstacles: Math.min(8 + (level - 1) * 2, 25), // –ú–∞–∫—Å–∏–º—É–º 25 –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏–π
                burrows: 1,
                traps: Math.max(0, Math.min(level - 2, 5)), // –ú–∞–∫—Å–∏–º—É–º 5 –º—ã—à–µ–ª–æ–≤–æ–∫
            };

            // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä –ø–æ–ª—è, —á—Ç–æ–±—ã –Ω–µ –≤—ã—Ö–æ–¥–∏–ª –∑–∞ –≥—Ä–∞–Ω–∏—Ü—ã –æ–∫–Ω–∞ –±—Ä–∞—É–∑–µ—Ä–∞
            const maxWidth = Math.min(window.innerWidth * 0.95, 2400);
            const maxHeight = Math.min(window.innerHeight * 0.85, 1800);

            let roomWidth = 1000 + (level - 1) * 150;
            let roomHeight = 800 + (level - 1) * 100;

            // –ù–µ –ø—Ä–µ–≤—ã—à–∞–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–µ —Ä–∞–∑–º–µ—Ä—ã
            roomWidth = Math.min(roomWidth, maxWidth);
            roomHeight = Math.min(roomHeight, maxHeight);

            return { ...base, roomWidth, roomHeight };
        }

        // ==================== –ü–†–û–°–¢–†–ê–ù–°–¢–í–ï–ù–ù–ê–Ø –°–ï–¢–ö–ê ====================
        class SpatialGrid {
            constructor(width, height, cellSize = 100) {
                this.cellSize = cellSize;
                this.cols = Math.ceil(width / cellSize);
                this.rows = Math.ceil(height / cellSize);
                this.grid = Array(this.cols * this.rows).fill(null).map(() => ({
                    mice: [], cats: [], obstacles: [], items: []
                }));
            }

            getCell(x, y) {
                const col = Math.floor(x / this.cellSize);
                const row = Math.floor(y / this.cellSize);
                if (col < 0 || col >= this.cols || row < 0 || row >= this.rows) return null;
                return this.grid[row * this.cols + col];
            }

            getNearby(x, y, distance) {
                const result = { mice: [], cats: [], obstacles: [], items: [] };
                const bounds = getGridBounds(x, y, distance, this);
                const { minCol, maxCol, minRow, maxRow } = bounds;

                for (let row = minRow; row <= maxRow; row++) {
                    for (let col = minCol; col <= maxCol; col++) {
                        // ‚≠ê v3.6.0: –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–¨ - –ø—Ä–æ–≤–µ—Ä—è–µ–º –≥—Ä–∞–Ω–∏—Ü—ã –ø–µ—Ä–µ–¥ –¥–æ—Å—Ç—É–ø–æ–º –∫ –º–∞—Å—Å–∏–≤—É
                        if (row < 0 || row >= this.rows || col < 0 || col >= this.cols) continue;
                        const cell = this.grid[row * this.cols + col];
                        if (!cell) continue;  // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∑–∞—â–∏—Ç–∞
                        // –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è: –≤–º–µ—Å—Ç–æ spread –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ü–∏–∫–ª (–±—ã—Å—Ç—Ä–µ–µ –Ω–∞ –±–æ–ª—å—à–∏—Ö –º–∞—Å—Å–∏–≤–∞—Ö)
                        for (let i = 0; i < cell.mice.length; i++) result.mice.push(cell.mice[i]);
                        for (let i = 0; i < cell.cats.length; i++) result.cats.push(cell.cats[i]);
                        for (let i = 0; i < cell.obstacles.length; i++) result.obstacles.push(cell.obstacles[i]);
                        for (let i = 0; i < cell.items.length; i++) result.items.push(cell.items[i]);
                    }
                }
                return result;
            }

            clear() {
                for (let i = 0; i < this.grid.length; i++) {
                    this.grid[i].mice.length = 0;
                    this.grid[i].cats.length = 0;
                    this.grid[i].obstacles.length = 0;
                    this.grid[i].items.length = 0;
                }
            }

            insert(type, x, y, obj) {
                const cell = this.getCell(x, y);
                if (cell) cell[type].push(obj);
            }
        }

        // ==================== –ü–£–õ–õ –ß–ê–°–¢–ò–¶ ====================
        class ParticlePool {
            constructor(size = 500) {
                this.pool = [];
                this.active = [];
                for (let i = 0; i < size; i++) {
                    this.pool.push({
                        x: 0, y: 0, vx: 0, vy: 0, life: 0, emoji: '‚ú®'
                    });
                }
            }

            get(x, y, emoji = '‚ú®') {
                const p = this.pool.length > 0 ? this.pool.pop() :
                    { x: 0, y: 0, vx: 0, vy: 0, life: 0, emoji: '‚ú®' };
                p.x = x;
                p.y = y;
                p.vx = (Math.random() - 0.5) * 6;
                p.vy = (Math.random() - 0.5) * 6 - 2;
                p.life = 1;
                p.emoji = emoji;
                this.active.push(p);
                return p;
            }

            update() {
                // ‚≠ê v3.6.0: –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–Ø - –∏–∑–±–µ–≥–∞–µ–º O(n) –æ–ø–µ—Ä–∞—Ü–∏–π shift() –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —á–∞—Å—Ç–∏—Ü
                const maxActive = 150;
                if (this.active.length > maxActive) {
                    // –í–º–µ—Å—Ç–æ shift() (O(n)) –∏—Å–ø–æ–ª—å–∑—É–µ–º slice (O(n) –æ–¥–∏–Ω —Ä–∞–∑ –≤–º–µ—Å—Ç–æ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö)
                    const toRemove = this.active.length - maxActive;
                    for (let j = 0; j < toRemove; j++) {
                        this.pool.push(this.active[j]);  // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –≤ –ø—É–ª –ø–µ—Ä–≤—ã–µ toRemove —ç–ª–µ–º–µ–Ω—Ç–æ–≤
                    }
                    // –£–¥–∞–ª—è–µ–º –ø–µ—Ä–≤—ã–µ toRemove —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –∑–∞ –æ–¥–∏–Ω —Ä–∞–∑ (O(n))
                    this.active.splice(0, toRemove);
                }

                // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ —á–∞—Å—Ç–∏—Ü—ã –≤ –æ–±—Ä–∞—Ç–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ —É–¥–∞–ª–µ–Ω–∏—è
                for (let i = this.active.length - 1; i >= 0; i--) {
                    const p = this.active[i];
                    p.x += p.vx;
                    p.y += p.vy;
                    p.vy += 0.2;
                    p.life -= 0.05;
                    if (p.life <= 0) {
                        // –í–º–µ—Å—Ç–æ splice (O(n)) —É–¥–∞–ª—è–µ–º –ø—Ä—è–º–æ –ø–æ –∏–Ω–¥–µ–∫—Å—É
                        // (–ø–æ–ª–∞–≥–∞–µ–º—Å—è –Ω–∞ —Ü–∏–∫–ª –≤ –æ–±—Ä–∞—Ç–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ)
                        this.pool.push(this.active[i]);
                        this.active[i] = this.active[this.active.length - 1];  // –ü–µ—Ä–µ–º–µ—â–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π —ç–ª–µ–º–µ–Ω—Ç
                        this.active.pop();  // –£–¥–∞–ª—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π —ç–ª–µ–º–µ–Ω—Ç (O(1))
                    }
                }
            }

            draw(ctx) {
                for (let i = 0; i < this.active.length; i++) {
                    const p = this.active[i];
                    ctx.globalAlpha = p.life;
                    // –ß–∞—Å—Ç–∏—Ü—ã - –ø—ã—Ç–∞–µ–º—Å—è —ç–º–æ–¥–∑–∏, –Ω–æ –º–æ–≥—É—Ç –±—ã—Ç—å –Ω–µ–≤–∏–¥–∏–º—ã
                    drawEmoji(ctx, p.emoji, p.x, p.y, 20 * p.life);
                }
            }
        }

        // ==================== –£–¢–ò–õ–ò–¢–´ –ü–†–û–í–ï–†–ö–ò –ì–†–ê–ù–ò–¶ ====================

        // –ó–∞–∂–∏–º–∞–µ—Ç –ø–æ–∑–∏—Ü–∏—é –æ–±—ä–µ–∫—Ç–∞ –≤ –ø—Ä–µ–¥–µ–ª—ã –≥—Ä–∞–Ω–∏—Ü –∫–∞–Ω–≤—ã
        function clampToCanvasBounds(entity, gameState, padding = 30, onBound = null) {
            const canvas = gameState.canvas;
            let didCollide = false;

            // –õ–µ–≤–∞—è –≥—Ä–∞–Ω–∏—Ü–∞
            if (entity.x - entity.radius < padding) {
                entity.x = entity.radius + padding;
                if (onBound) onBound('left');
                didCollide = true;
            }
            // –ü—Ä–∞–≤–∞—è –≥—Ä–∞–Ω–∏—Ü–∞
            if (entity.x + entity.radius > canvas.width - padding) {
                entity.x = canvas.width - entity.radius - padding;
                if (onBound) onBound('right');
                didCollide = true;
            }
            // –í–µ—Ä—Ö–Ω—è—è –≥—Ä–∞–Ω–∏—Ü–∞
            if (entity.y - entity.radius < padding) {
                entity.y = entity.radius + padding;
                if (onBound) onBound('top');
                didCollide = true;
            }
            // –ù–∏–∂–Ω—è—è –≥—Ä–∞–Ω–∏—Ü–∞
            if (entity.y + entity.radius > canvas.height - padding) {
                entity.y = canvas.height - entity.radius - padding;
                if (onBound) onBound('bottom');
                didCollide = true;
            }

            return didCollide;
        }

        // –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –≥—Ä–∞–Ω–∏—Ü—ã —è—á–µ–µ–∫ —Å–µ—Ç–∫–∏ –¥–ª—è –∑–∞–¥–∞–Ω–Ω–æ–≥–æ —Ä–∞–¥–∏—É—Å–∞ –ø–æ–∏—Å–∫–∞
        function getGridBounds(x, y, distance, grid) {
            return {
                minCol: Math.max(0, Math.floor((x - distance) / grid.cellSize)),
                maxCol: Math.min(grid.cols - 1, Math.floor((x + distance) / grid.cellSize)),
                minRow: Math.max(0, Math.floor((y - distance) / grid.cellSize)),
                maxRow: Math.min(grid.rows - 1, Math.floor((y + distance) / grid.cellSize))
            };
        }

        // –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ª–∏ —Ç–æ—á–∫–∞ –≤–Ω—É—Ç—Ä–∏ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è (–∏—Å–ø–æ–ª—å–∑—É—è –∫–≤–∞–¥—Ä–∞—Ç –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏)
        function isWithinDistanceSq(x1, y1, x2, y2, maxDistSq) {
            const dx = x2 - x1;
            const dy = y2 - y1;
            const distSq = dx * dx + dy * dy;
            return distSq < maxDistSq && distSq > 0;
        }

        // –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ª–∏ –ø–æ–∑–∏—Ü–∏—è –≤ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –¥–ª—è —Å–ø–∞—É–Ω–∞
        function isSpawnSafe(x, y, obstacles, minRadius = 120) {
            const minRadiusSq = minRadius * minRadius;
            for (let i = 0; i < obstacles.length; i++) {
                const obs = obstacles[i];
                const dx = obs.x - x;
                const dy = obs.y - y;
                if (dx * dx + dy * dy < minRadiusSq) {
                    return false;
                }
            }
            return true;
        }

        // –í—ã—á–∏—Å–ª—è–µ—Ç —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –º–µ–∂–¥—É –¥–≤—É–º—è —Ç–æ—á–∫–∞–º–∏ (–∫–æ—Ä–µ–Ω—å –∏–∑ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è –≤ –∫–≤–∞–¥—Ä–∞—Ç–µ)
        function getDistance(x1, y1, x2, y2) {
            const dx = x2 - x1;
            const dy = y2 - y1;
            return Math.sqrt(dx * dx + dy * dy);
        }

        // –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–æ–ª—å–∫–æ –∫–≤–∞–¥—Ä–∞—Ç —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è (–±–æ–ª–µ–µ –±—ã—Å—Ç—Ä–æ –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏–π)
        function getDistanceSq(x1, y1, x2, y2) {
            const dx = x2 - x1;
            const dy = y2 - y1;
            return dx * dx + dy * dy;
        }

        // ==================== –£–¢–ò–õ–ò–¢–´ –£–ü–†–ê–í–õ–ï–ù–ò–Ø –≠–ö–†–ê–ù–ê–ú–ò ====================

        // –°–∫—Ä—ã–≤–∞–µ—Ç –≤—Å–µ –∏–≥—Ä–æ–≤—ã–µ —ç–∫—Ä–∞–Ω—ã
        function hideAllScreens() {
            if (DOM.menuScreen) DOM.menuScreen.classList.remove('active');
            if (DOM.pauseScreen) DOM.pauseScreen.classList.remove('active');
            if (DOM.levelCompleteScreen) DOM.levelCompleteScreen.classList.remove('active');
            if (DOM.gameOverScreen) DOM.gameOverScreen.classList.remove('active');
            if (DOM.leaderboardScreen) DOM.leaderboardScreen.style.display = 'none';
            if (DOM.scoreInputPanel) DOM.scoreInputPanel.style.display = 'none';
        }

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —ç–∫—Ä–∞–Ω (—Å–∫—Ä—ã–≤–∞—è –æ—Å—Ç–∞–ª—å–Ω—ã–µ)
        function showScreen(screenType) {
            hideAllScreens();
            switch (screenType) {
                case 'menu':
                    if (DOM.menuScreen) DOM.menuScreen.classList.add('active');
                    break;
                case 'pause':
                    if (DOM.pauseScreen) DOM.pauseScreen.classList.add('active');
                    break;
                case 'levelComplete':
                    if (DOM.levelCompleteScreen) DOM.levelCompleteScreen.classList.add('active');
                    break;
                case 'gameOver':
                    if (DOM.gameOverScreen) DOM.gameOverScreen.classList.add('active');
                    if (DOM.scoreInputPanel) DOM.scoreInputPanel.style.display = 'block';
                    // ‚≠ê v3.6.0: –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π —Ñ–æ–∫—É—Å - –∏—Å–ø–æ–ª—å–∑—É–µ–º try-catch –∏ defer —á–µ—Ä–µ–∑ requestAnimationFrame
                    if (DOM.playerName) {
                        try {
                            // –ò—Å–ø–æ–ª—å–∑—É–µ–º requestAnimationFrame —á—Ç–æ–±—ã —Ñ–æ–∫—É—Å –ø—Ä–æ–∏–∑–æ—à–µ–ª –ø–æ—Å–ª–µ –ø–æ–ª–Ω–æ–≥–æ —Ä–µ–Ω–¥–µ—Ä–∞
                            requestAnimationFrame(() => {
                                if (DOM.playerName && DOM.playerName !== document.activeElement) {
                                    DOM.playerName.focus();
                                }
                            });
                        } catch (e) {
                            console.log('Focus –æ—à–∏–±–∫–∞ (–Ω–µ–∫—Ä–∏—Ç–∏—á–Ω–∞):', e);
                        }
                    }
                    break;
                case 'leaderboard':
                    if (DOM.leaderboardScreen) DOM.leaderboardScreen.style.display = 'block';
                    break;
                case 'scoreInput':
                    if (DOM.scoreInputPanel) DOM.scoreInputPanel.style.display = 'block';
                    break;
            }
            
            // ‚≠ê v3.6.0: –§–ò–ß–ê - –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –Ω–∞–≤–∏–≥–∞—Ü–∏—é –ø–æ –º–µ–Ω—é –¥–ª—è –¥–∂–æ–π—Å—Ç–∏–∫–∞
            initMenuNavigation();
        }

        // ==================== –ö–õ–ê–°–°–´ ====================
        class Mouse {
            constructor(x, y) {
                this.x = x;
                this.y = y;
                this.vx = 0;
                this.vy = 0;
                this.radius = CONFIG.mouseSize;
                this.alive = true;
                this.emoji = 'üê≠';
                this.stamina = CONFIG.maxStamina;
                this.isSprinting = false;
                this.noiseLevel = 0;
                this.hidden = false;
                this.hp = CONFIG.mouseMaxHP;
                this.inBurrow = false;
                this.burrowHealingTimer = 0;
            }

            update(grid, gameState, mergedInput, deltaTime = 1) {
                // ‚≠ê v3.6.0: –ú–û–î–£–õ–¨–ù–´–ô UPDATE - –≤—ã–∑—ã–≤–∞–µ—Ç –ø–æ–¥–º–µ—Ç–æ–¥—ã –≤–º–µ—Å—Ç–æ inline-–∫–æ–¥–∞
                const input = mergedInput || getMergedInput();

                if (!this.alive) return;

                // –ë–∞–∑–æ–≤–∞—è —Ñ–∏–∑–∏–∫–∞
                this.vx *= CONFIG.friction;
                this.vy *= CONFIG.friction;

                const isSelected = gameState.selectedMouse === gameState.mice.indexOf(this);

                // –î–≤–∏–∂–µ–Ω–∏–µ –∏ –≤—ã–Ω–æ—Å–ª–∏–≤–æ—Å—Ç—å
                const { isMoving, isSprintActive } = this.updateMovement(input, deltaTime);
                this.updateStamina(isMoving, isSprintActive, deltaTime);
                if (isSprintActive && isMoving) gameState.globalNoise += 3 * deltaTime;
                if (isMoving && !isSprintActive) gameState.globalNoise += 1 * deltaTime;
                this.updateNoise(deltaTime);

                // –ö–æ–ª–ª–∏–∑–∏–∏ –∏ –ø–æ–∑–∏—Ü–∏—è
                this.checkObstacleCollisions(gameState);
                this.updateBurrow(input, gameState, isSelected);
                this.updateHiding(gameState);
                this.updatePosition(gameState);
                this.checkMouseCollisions(gameState);

                // –°–±–æ—Ä –ø—Ä–µ–¥–º–µ—Ç–æ–≤ –∏ –≤—Ä–∞–≥–∏
                this.checkCheeseCollisions(gameState);
                this.checkCatCollisions(gameState);
                this.checkTrapCollisions(gameState);
            }

            // ‚≠ê v3.6.0: –ü–û–î–ú–ï–¢–û–î–´ MOUSE.UPDATE - –†–∞–∑–±–∏–µ–Ω–∏–µ 187 —Å—Ç—Ä–æ–∫ –Ω–∞ –º–æ–¥—É–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏

            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–≤–∏–∂–µ–Ω–∏—è –Ω–∞ –æ—Å–Ω–æ–≤–µ input
            updateMovement(input, deltaTime) {
                const isSprintActive = input.keys['Shift'] && this.stamina > 10;
                const speed = (isSprintActive ? CONFIG.mouseSprintSpeed : CONFIG.mouseSpeed) * deltaTime;

                let isMoving = false;
                if (input.keys['w'] || input.keys['ArrowUp']) { this.vy -= speed; isMoving = true; }
                if (input.keys['s'] || input.keys['ArrowDown']) { this.vy += speed; isMoving = true; }
                if (input.keys['a'] || input.keys['ArrowLeft']) { this.vx -= speed; isMoving = true; }
                if (input.keys['d'] || input.keys['ArrowRight']) { this.vx += speed; isMoving = true; }

                return { isMoving, isSprintActive };
            }

            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—ã–Ω–æ—Å–ª–∏–≤–æ—Å—Ç–∏
            updateStamina(isMoving, isSprintActive, deltaTime) {
                if (isSprintActive && isMoving && this.stamina > 0) {
                    this.stamina -= CONFIG.staminaDecayRun * deltaTime;
                    this.noiseLevel += 5 * deltaTime;
                    return true;
                } else if (isMoving && this.stamina < CONFIG.maxStamina) {
                    this.noiseLevel += 2 * deltaTime;
                    this.stamina = Math.min(this.stamina + CONFIG.staminaRecovery * deltaTime, CONFIG.maxStamina);
                    return false;
                } else if (this.stamina < CONFIG.maxStamina) {
                    this.stamina = Math.min(this.stamina + CONFIG.staminaRecovery * deltaTime, CONFIG.maxStamina);
                    return false;
                }
            }

            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —É—Ä–æ–≤–Ω—è —à—É–º–∞
            updateNoise(deltaTime) {
                this.noiseLevel = Math.max(0, this.noiseLevel - CONFIG.noiseDecay * deltaTime);
            }

            // –ö–æ–ª–ª–∏–∑–∏–∏ —Å –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏—è–º–∏
            checkObstacleCollisions(gameState) {
                const nearbyObjects = gameState.grid.getNearby(this.x, this.y, 150);
                for (let i = 0; i < nearbyObjects.obstacles.length; i++) {
                    const obs = nearbyObjects.obstacles[i];
                    const distSq = getDistanceSq(this.x, this.y, obs.x, obs.y);
                    const minDist = (this.radius + obs.radius) * (this.radius + obs.radius);

                    if (distSq < minDist && distSq > 0) {
                        const dist = Math.sqrt(distSq);
                        const dx = obs.x - this.x;
                        const dy = obs.y - this.y;
                        const push = (Math.sqrt(minDist) - dist) * 0.6;
                        this.x -= (dx / dist) * push;
                        this.y -= (dy / dist) * push;
                        this.vx *= 0.7;
                        this.vy *= 0.7;
                    }
                }
            }

            // –õ–æ–≥–∏–∫–∞ –Ω–æ—Ä–∫–∏
            updateBurrow(input, gameState, isSelected) {
                let nearBurrow = false;
                for (let i = 0; i < gameState.burrows.length; i++) {
                    const burrow = gameState.burrows[i];
                    const burrowRange = (CONFIG.burrowRadius + this.radius) * (CONFIG.burrowRadius + this.radius);
                    if (getDistanceSq(this.x, this.y, burrow.x, burrow.y) < burrowRange) {
                        nearBurrow = true;
                        // ‚≠ê v3.6.0: –§–ò–ß–ê - –õ–Æ–ë –ê–Ø –º—ã—à—å –º–æ–∂–µ—Ç –ø—Ä—è—Ç–∞—Ç—å—Å—è –≤ –Ω–æ—Ä–∫—É, –Ω–µ —Ç–æ–ª—å–∫–æ –≤–µ–¥—É—â–∞—è!
                        if (input.keys['e'] && !this.inBurrow) {
                            this.inBurrow = true;
                            playSound('burrow');
                        }
                        break;
                    }
                }

                if (this.inBurrow && !nearBurrow) {
                    this.inBurrow = false;
                    this.burrowHealingTimer = 0;
                }

                if (this.inBurrow) {
                    this.burrowHealingTimer++;
                    if (this.burrowHealingTimer % 5 === 0) {
                        this.hp = Math.min(this.hp + CONFIG.healingSpeed, CONFIG.mouseMaxHP);
                    }
                } else {
                    this.burrowHealingTimer = 0;
                }
            }

            // –°–∫—Ä—ã—Ç–∏–µ –∑–∞ –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏—è–º–∏
            updateHiding(gameState) {
                this.hidden = false;
                const nearby = gameState.grid.getNearby(this.x, this.y, 100);
                for (let i = 0; i < nearby.obstacles.length; i++) {
                    const obs = nearby.obstacles[i];
                    const hideRange = (this.radius + obs.radius + 20) * (this.radius + obs.radius + 20);
                    if (getDistanceSq(this.x, this.y, obs.x, obs.y) < hideRange) {
                        this.hidden = true;
                        break;
                    }
                }
            }

            // –ü–æ–∑–∏—Ü–∏—è –∏ –≥—Ä–∞–Ω–∏—Ü—ã
            updatePosition(gameState) {
                this.x += this.vx;
                this.y += this.vy;
                clampToCanvasBounds(this, gameState);
            }

            // –û—Ç—Ç–∞–ª–∫–∏–≤–∞–Ω–∏–µ –æ—Ç –º—ã—à–µ–π
            checkMouseCollisions(gameState) {
                for (let i = 0; i < gameState.mice.length; i++) {
                    const other = gameState.mice[i];
                    if (other === this || !other.alive) continue;
                    const distSq = getDistanceSq(this.x, this.y, other.x, other.y);
                    const minDist = (this.radius + other.radius) * 1.2;
                    if (distSq < minDist * minDist && distSq > 0) {
                        const dist = Math.sqrt(distSq);
                        const dx = other.x - this.x;
                        const dy = other.y - this.y;
                        const push = (minDist - dist) * 0.5;
                        this.x -= (dx / dist) * push;
                        this.y -= (dy / dist) * push;
                    }
                }
            }

            // –°—ã—Ä
            checkCheeseCollisions(gameState) {
                for (let i = gameState.cheese.length - 1; i >= 0; i--) {
                    const cheese = gameState.cheese[i];
                    const minDistSq = (this.radius + cheese.radius) * (this.radius + cheese.radius);
                    if (getDistanceSq(this.x, this.y, cheese.x, cheese.y) < minDistSq) {
                        gameState.collectedCheese++;
                        gameState.score += (gameState.currentLevel * 10) + (this.stamina > 80 ? 20 : 5);
                        for (let j = 0; j < 8; j++) gameState.particles.get(cheese.x, cheese.y, 'üßÄ');
                        gameState.cheese.splice(i, 1);
                        playSound('cheese');
                    }
                }
            }

            // –ö–æ—à–∫–∏
            checkCatCollisions(gameState) {
                if (this.inBurrow) return;

                for (let i = 0; i < gameState.cats.length; i++) {
                    const cat = gameState.cats[i];
                    if (cat.canSee(this) || cat.canHear(this)) {
                        if (!cat.target) playSound('danger');
                        cat.target = this;
                    }
                    const catchDist = this.radius + cat.radius;
                    if (getDistanceSq(this.x, this.y, cat.x, cat.y) < catchDist * catchDist) {
                        this.hp -= CONFIG.catDamage;
                        playSound('damage');
                        if (this.hp <= 0) {
                            this.alive = false;
                            for (let j = 0; j < 5; j++) gameState.particles.get(this.x, this.y, 'üíî');
                            playSound('caught');
                        }
                    }
                }
            }

            // –ú—ã—à–µ–ª–æ–≤–∫–∏
            checkTrapCollisions(gameState) {
                if (this.inBurrow) return;

                for (let i = 0; i < gameState.traps.length; i++) {
                    const trap = gameState.traps[i];
                    const minDistSq = (this.radius + trap.radius) * (this.radius + trap.radius);
                    if (getDistanceSq(this.x, this.y, trap.x, trap.y) < minDistSq) {
                        this.alive = false;
                        for (let j = 0; j < 5; j++) gameState.particles.get(this.x, this.y, 'üí•');
                        playSound('trap');
                    }
                }
            }

            draw(ctx) {
                if (!this.alive) return;

                // –†–∏—Å—É–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ–π –º—ã—à–∏ (–µ—Å–ª–∏ —ç—Ç–æ –æ–Ω–∞)
                if (gameState.selectedMouse === gameState.mice.indexOf(this)) {
                    ctx.save();
                    ctx.strokeStyle = 'rgba(255, 215, 0, 0.8)';
                    ctx.lineWidth = 3;
                    ctx.beginPath();
                    ctx.arc(this.x, this.y, this.radius + 10, 0, Math.PI * 2);
                    ctx.stroke();
                    ctx.restore();

                    // HP –±–∞—Ä
                    ctx.save();
                    const barWidth = 50;
                    const barHeight = 5;
                    ctx.fillStyle = 'rgba(0, 0, 0, 0.5)';
                    ctx.fillRect(this.x - barWidth / 2, this.y - this.radius - 25, barWidth, barHeight);
                    const hpRatio = this.hp / CONFIG.mouseMaxHP;
                    const barColor = hpRatio > 0.5 ? '#4CAF50' : hpRatio > 0.2 ? '#FFC107' : '#FF5722';
                    ctx.fillStyle = barColor;
                    ctx.fillRect(this.x - barWidth / 2, this.y - this.radius - 25, barWidth * hpRatio, barHeight);
                    ctx.restore();
                }

                // –ú—ã—à—å (—ç—Ñ—Ñ–µ–∫—Ç –ø—Ä—è—á–µ—Ç—Å—è –≤ –Ω–æ—Ä–∫–µ)
                ctx.save();
                let fontSize = this.radius * 2;
                let alpha = 1;

                if (this.inBurrow) {
                    // –ú—ã—à—å –≤ –Ω–æ—Ä–∫–µ - –º–µ–Ω—å—à–µ —Ä–∞–∑–º–µ—Ä –∏ –ø–æ–ª—É–ø—Ä–æ–∑—Ä–∞—á–Ω–∞
                    fontSize = this.radius * 1.4;
                    alpha = 0.6;
                    // –≠—Ñ—Ñ–µ–∫—Ç –º–µ—Ä—Ü–∞–Ω–∏—è –≤ –Ω–æ—Ä–∫–µ
                    const flicker = Math.sin(Date.now() * 0.01) * 0.2 + 0.8;
                    alpha *= flicker;
                }

                ctx.globalAlpha = alpha;
                // –†–∏—Å—É–µ–º –∫—Ä–∞—Å–∏–≤—É—é –º—ã—à—å —ç–º–æ–¥–∑–∏
                drawEmoji(ctx, this.emoji, this.x, this.y, fontSize);

                // –ï—Å–ª–∏ –≤ –Ω–æ—Ä–∫–µ, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —ç—Ñ—Ñ–µ–∫—Ç "—É–∫—Ä—ã—Ç–∏—è"
                if (this.inBurrow) {
                    ctx.globalAlpha = 0.3;
                    ctx.fillStyle = 'rgba(100, 150, 100, 0.5)';
                    ctx.beginPath();
                    ctx.arc(this.x, this.y, this.radius + 8, 0, Math.PI * 2);
                    ctx.fill();
                }

                ctx.restore();
            }
        }

        class Cat {
            constructor(x, y) {
                this.x = x;
                this.y = y;
                this.vx = 0;
                this.vy = 0;
                this.radius = CONFIG.catSize;
                this.emoji = 'üò∫';
                this.target = null;
                this.direction = Math.random() * Math.PI * 2;
                this.targetDirection = this.direction;
                this.patrolTimer = 0;
                this.chaseTimer = 0;
                this.alertLevel = 0;
                this.lastSeenPosition = null;
            }

            canSee(mouse) {
                if (!mouse.alive || mouse.hidden) return false;
                if (getDistanceSq(this.x, this.y, mouse.x, mouse.y) > CONFIG.catVisionRange * CONFIG.catVisionRange) return false;

                const dx = mouse.x - this.x;
                const dy = mouse.y - this.y;
                const angleToMouse = Math.atan2(dy, dx);
                let angleDiff = Math.abs(this.direction - angleToMouse);
                if (angleDiff > Math.PI) angleDiff = 2 * Math.PI - angleDiff;
                return angleDiff < (CONFIG.catVisionAngle * Math.PI / 180 / 2);
            }

            canHear(mouse) {
                if (!mouse.alive) return false;
                return getDistanceSq(this.x, this.y, mouse.x, mouse.y) < CONFIG.catHearingRange * CONFIG.catHearingRange && mouse.noiseLevel > 15;
            }

            update(gameState, deltaTime = 1) {
                // ‚≠ê v3.6.0: deltaTime –Ω–æ—Ä–º–∞–ª–∏–∑—É–µ—Ç –¥–≤–∏–∂–µ–Ω–∏–µ –∫–æ—à–µ–∫ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —á–∞—Å—Ç–æ—Ç —ç–∫—Ä–∞–Ω–∞
                // ‚≠ê v3.6.0: –≠–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–µ –∑–∞—Ç—É—Ö–∞–Ω–∏–µ friction –Ω–∞ —Ä–∞–∑–Ω—ã—Ö —á–∞—Å—Ç–æ—Ç–∞—Ö —ç–∫—Ä–∞–Ω–∞
                const frictionFactor = Math.pow(CONFIG.friction, deltaTime);
                this.vx *= frictionFactor;
                this.vy *= frictionFactor;
                this.alertLevel = Math.max(0, this.alertLevel - 1 * deltaTime);

                let angleDiff = this.targetDirection - this.direction;
                if (angleDiff > Math.PI) angleDiff -= 2 * Math.PI;
                if (angleDiff < -Math.PI) angleDiff += 2 * Math.PI;
                this.direction += angleDiff * 0.1 * deltaTime;

                if (this.target && this.target.alive) {
                    this.chaseTimer += deltaTime;
                    this.alertLevel = Math.min(this.alertLevel + 8 * deltaTime, 100);
                    const dx = this.target.x - this.x;
                    const dy = this.target.y - this.y;
                    const distSq = dx * dx + dy * dy;

                    if (distSq > 25) {
                        const dist = Math.sqrt(distSq);
                        const chaseSpeed = CONFIG.catChaseSpeed + (this.alertLevel / 100) * 0.5;
                        this.vx += (dx / dist) * chaseSpeed * deltaTime;
                        this.vy += (dy / dist) * chaseSpeed * deltaTime;
                        this.targetDirection = Math.atan2(dy, dx);
                    }

                    if (!this.canSee(this.target) && !this.canHear(this.target)) {
                        this.chaseTimer += deltaTime;
                        if (this.chaseTimer > 200) {
                            this.target = null;
                            this.chaseTimer = 0;
                            this.alertLevel = Math.max(0, this.alertLevel - 20);
                        }
                    }
                } else {
                    this.chaseTimer = 0;
                    if (this.lastSeenPosition) {
                        const dx = this.lastSeenPosition.x - this.x;
                        const dy = this.lastSeenPosition.y - this.y;
                        const distSq = dx * dx + dy * dy;

                        if (distSq > 400) {
                            const dist = Math.sqrt(distSq);
                            this.vx += (dx / dist) * CONFIG.catSpeed * 0.8 * deltaTime;
                            this.vy += (dy / dist) * CONFIG.catSpeed * 0.8 * deltaTime;
                            this.targetDirection = Math.atan2(dy, dx);
                        } else {
                            this.lastSeenPosition = null;
                        }
                    } else {
                        this.patrolTimer += deltaTime;
                        if (this.patrolTimer > 80) {
                            this.targetDirection = Math.random() * Math.PI * 2;
                            this.patrolTimer = 0;
                        }
                        this.vx += Math.cos(this.targetDirection) * CONFIG.catSpeed * 0.3 * deltaTime;
                        this.vy += Math.sin(this.targetDirection) * CONFIG.catSpeed * 0.3 * deltaTime;
                    }
                }

                const speed = Math.sqrt(this.vx * this.vx + this.vy * this.vy);
                // ‚≠ê v3.6.0: maxSpeed –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –Ω–∞ deltaTime!
                // –ò–Ω–∞—á–µ –Ω–∞ 120Hz –∫–æ—Ç—ã –¥–≤–∏–≥–∞—é—Ç—Å—è –≤–¥–≤–æ–µ –±—ã—Å—Ç—Ä–µ–µ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
                const maxSpeedBase = this.target ? 4.5 : 3.0;
                const maxSpeed = maxSpeedBase * deltaTime;
                if (speed > maxSpeed) {
                    this.vx = (this.vx / speed) * maxSpeed;
                    this.vy = (this.vy / speed) * maxSpeed;
                }

                this.x += this.vx;
                this.y += this.vy;

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–ª–ª–∏–∑–∏–∏ —Å –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏—è–º–∏
                const nearbyObjects = gameState.grid.getNearby(this.x, this.y, 150);
                for (let i = 0; i < nearbyObjects.obstacles.length; i++) {
                    const obs = nearbyObjects.obstacles[i];
                    const dx = obs.x - this.x;
                    const dy = obs.y - this.y;
                    const distSq = dx * dx + dy * dy;
                    const minDist = (this.radius + obs.radius) * (this.radius + obs.radius);

                    if (distSq < minDist && distSq > 0) {
                        const dist = Math.sqrt(distSq);
                        const push = (Math.sqrt(minDist) - dist) * 0.6;
                        this.x -= (dx / dist) * push;
                        this.y -= (dy / dist) * push;
                        this.vx *= 0.7;
                        this.vy *= 0.7;
                    }
                }

                // –ó–∞–∂–∏–º–∞–µ–º –≤ –≥—Ä–∞–Ω–∏—Ü—ã —Å –æ—Å–æ–±–æ–π –ª–æ–≥–∏–∫–æ–π –¥–ª—è –∫–æ—Ç–æ–≤ (—Å–±—Ä–æ—Å —Å–∫–æ—Ä–æ—Å—Ç–∏ –∏ –Ω–æ–≤–æ–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ)
                clampToCanvasBounds(this, gameState, 30, (direction) => {
                    if (direction === 'left' || direction === 'right') this.vx = 0;
                    if (direction === 'top' || direction === 'bottom') this.vy = 0;
                    this.targetDirection = Math.random() * Math.PI * 2;
                });
            }

            draw(ctx) {
                const halfAngle = CONFIG.catVisionAngle * Math.PI / 180 / 2;
                const intensity = 0.15 + (this.alertLevel / 100) * 0.35;

                // –†–∏—Å—É–µ–º –≤–∏–¥–µ–Ω–∏–µ –æ—Ç–¥–µ–ª—å–Ω–æ
                ctx.save();
                ctx.fillStyle = `rgba(255, 50, 50, ${intensity * 0.3})`;
                ctx.beginPath();
                ctx.moveTo(this.x, this.y);
                ctx.arc(this.x, this.y, CONFIG.catVisionRange, this.direction - halfAngle, this.direction + halfAngle);
                ctx.closePath();
                ctx.fill();
                ctx.restore();

                // –ö–æ—à–∫–∞ –í–°–ï–ì–î–ê –ø–æ–ª–Ω–æ—Å—Ç—å—é –≤–∏–¥–Ω–∞ - –∫—Ä–∞—Å–∏–≤—ã–π —ç–º–æ–¥–∑–∏!
                ctx.globalAlpha = 1; // –ö–†–ò–¢–ò–ß–ù–û: –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º 100% –≤–∏–¥–∏–º–æ—Å—Ç—å
                drawEmoji(ctx, this.emoji, this.x, this.y, this.radius * 2);
                ctx.restore();
            }
        }

        class Obstacle {
            constructor(x, y, type) {
                this.x = x;
                this.y = y;
                this.radius = CONFIG.obstacleSize;
                const emojis = ['ü™ë', 'üõèÔ∏è', 'üö™', 'ü™ü', 'üì∫', 'üåø', 'üõãÔ∏è', 'üè†', 'üöΩ', 'üöø', 'üì¶', 'ü™¥'];
                this.emoji = emojis[type % emojis.length];
            }

            draw(ctx) {
                ctx.globalAlpha = 1;
                // –ü—Ä–µ–ø—è—Ç—Å—Ç–≤–∏—è - —Ä–∏—Å—É–µ–º —ç–º–æ–¥–∑–∏ –µ—Å–ª–∏ –≤–æ–∑–º–æ–∂–Ω–æ, —ç—Ç–æ –¥–µ–∫–æ—Ä–∞—Ç–∏–≤–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã
                drawEmoji(ctx, this.emoji, this.x, this.y, this.radius * 2);
            }
        }

        class Cheese {
            constructor(x, y) {
                this.x = x;
                this.y = y;
                this.radius = CONFIG.cheeseSize;
                this.emoji = 'üßÄ';
                this.bobbing = Math.random() * Math.PI * 2;
            }

            update(deltaTime = 1) {
                // ‚≠ê v3.6.0: deltaTime –Ω–æ—Ä–º–∞–ª–∏–∑—É–µ—Ç –∞–Ω–∏–º–∞—Ü–∏—é –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —á–∞—Å—Ç–æ—Ç —ç–∫—Ä–∞–Ω–∞
                this.bobbing += 0.05 * deltaTime;
            }

            draw(ctx) {
                const bobOffset = Math.sin(this.bobbing) * 3;
                // –ö—Ä–∞—Å–∏–≤—ã–π —Å—ã—Ä —ç–º–æ–¥–∑–∏
                drawEmoji(ctx, this.emoji, this.x, this.y + bobOffset, this.radius * 2);
            }
        }

        class Burrow {
            constructor(x, y) {
                this.x = x;
                this.y = y;
                this.radius = CONFIG.burrowRadius;
                this.emoji = 'üï≥Ô∏è';
            }

            draw(ctx) {
                // –ö—Ä–∞—Å–∏–≤–∞—è –Ω–æ—Ä–∫–∞ —ç–º–æ–¥–∑–∏
                drawEmoji(ctx, this.emoji, this.x, this.y, this.radius * 2);
            }
        }

        class Trap {
            constructor(x, y) {
                this.x = x;
                this.y = y;
                this.radius = CONFIG.cheeseSize;
                this.emoji = 'ü™§';
            }

            draw(ctx) {
                // –ö—Ä–∞—Å–∏–≤–∞—è –ª–æ–≤—É—à–∫–∞ —ç–º–æ–¥–∑–∏
                drawEmoji(ctx, this.emoji, this.x, this.y, this.radius * 2);
            }
        }

        // ==================== –°–û–í–ï–¢–´ –ò –ü–û–î–°–ö–ê–ó–ö–ò ====================
        const TIPS = [
            "üí° –ü—Ä—è—á—å—Ç–µ—Å—å –∑–∞ –ø—Ä–µ–¥–º–µ—Ç—ã, —á—Ç–æ–±—ã –∫–æ—à–∫–∏ –≤–∞—Å –Ω–µ –≤–∏–¥–µ–ª–∏!",
            "üèÉ –°–ø—Ä–∏–Ω—Ç –∏–∑–¥–∞—ë—Ç –±–æ–ª—å—à–µ —à—É–º–∞ - –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –µ–≥–æ –≤ –∫—Ä–∞–π–Ω–µ–º —Å–ª—É—á–∞–µ!",
            "üï≥Ô∏è –ù–æ—Ä–∫–∏ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é—Ç –∑–¥–æ—Ä–æ–≤—å–µ - —Å–ø–∞—Å–∞–π—Ç–µ—Å—å –≤ –Ω–∏—Ö!",
            "üëÇ –ö–æ—à–∫–∏ —Å–ª—ã—à–∞—Ç –≥—Ä–æ–º–∫–∏–π —à—É–º - —Ö–æ–¥–∏—Ç–µ —Ç–∏—Ö–æ!",
            "üßÄ –°–æ–±–∏—Ä–∞–π—Ç–µ —Å—ã—Ä –±—ã—Å—Ç—Ä–æ, –Ω–æ –æ—Å—Ç–æ—Ä–æ–∂–Ω–æ - –∫–æ–º–±–æ –¥–∞—ë—Ç –±–æ–Ω—É—Å!",
            "‚≠ê –°–æ–±–µ—Ä–∏—Ç–µ –≤–µ—Å—å —Å—ã—Ä –∏ –¥–æ–π–¥–∏—Ç–µ –¥–æ –∫–æ–Ω—Ü–∞ —É—Ä–æ–≤–Ω—è!",
            "üéØ –ö–∞–∂–¥—ã–π —É—Ä–æ–≤–µ–Ω—å —Å–ª–æ–∂–Ω–µ–µ - –±—É–¥—å—Ç–µ –≤–Ω–∏–º–∞—Ç–µ–ª—å–Ω–µ–µ!",
            "üê± –ö–æ—à–∫–∏ –≤–∏–¥—è—Ç –≤ –∫–æ–Ω—É—Å–µ –≤–ø–µ—Ä–µ–¥–∏ —Å–µ–±—è - –æ–±—Ö–æ–¥–∏—Ç–µ –∏—Ö —Å–±–æ–∫—É!",
            "‚ö° –í—ã–Ω–æ—Å–ª–∏–≤–æ—Å—Ç—å –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –º–µ–¥–ª–µ–Ω–Ω–µ–µ –ø—Ä–∏ –±–æ–ª—å—à–æ–º —à—É–º–µ!",
            "üéÆ TAB –ø–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç –º—ã—à–µ–π - –≤—ã–±–∏—Ä–∞–π—Ç–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏—á–µ—Å–∫–∏!",
            "üïπÔ∏è PS4 –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è! Left Stick = –¥–≤–∏–∂–µ–Ω–∏–µ, –∫–Ω–æ–ø–∫–∏ = –¥–µ–π—Å—Ç–≤–∏—è"
        ];

        let currentTip = 0;
        function getNextTip() {
            const tip = TIPS[currentTip % TIPS.length];
            currentTip++;
            return tip;
        }

        function displayTip() {
            const tipElement = DOM.menuTip;
            if (tipElement) {
                tipElement.textContent = getNextTip();
            }
        }

        function rotateTip() {
            const tipElement = DOM.menuTip;
            if (tipElement) {
                tipElement.style.animation = 'none';
                setTimeout(() => {
                    tipElement.style.animation = 'tipFade 0.5s ease-in';
                    tipElement.textContent = getNextTip();
                }, 10);
            }
        }

        // ==================== –†–ï–ô–¢–ò–ù–ì –ò –õ–ò–î–ï–†–ë–û–†–î ====================
        /**
         * ‚≠ê v3.6.0: –¢–û–õ–¨–ö–û GitHub - –æ–¥–∏–Ω —Ä–µ–π—Ç–∏–Ω–≥ –¥–ª—è –≤—Å–µ—Ö –±—Ä–∞—É–∑–µ—Ä–æ–≤ –∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤!
         * –ó–∞–≥—Ä—É–∂–∞–µ—Ç —Ä–µ–π—Ç–∏–Ω–≥ —Å GitHub –ø—Ä–∏ –∫–∞–∂–¥–æ–º –≤—ã–∑–æ–≤–µ (–≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç—å)
         */
        async function getLeaderboard() {
            try {
                console.log('üìä –ó–∞–≥—Ä—É–∂–∞–µ–º —Ä–µ–π—Ç–∏–Ω–≥ —Å Vercel...');
                const response = await fetch(
                    '/leaderboard.json?t=' + Date.now(),  // –ò–∑–±–µ–≥–∞–µ–º –∫—ç—à–∞ –±—Ä–∞—É–∑–µ—Ä–∞
                    {
                        headers: {
                            'Cache-Control': 'no-cache',
                            'Pragma': 'no-cache'
                        }
                    }
                );
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                const leaderboard = data.scores || [];
                console.log(`‚úÖ –†–µ–π—Ç–∏–Ω–≥ –∑–∞–≥—Ä—É–∂–µ–Ω —Å Vercel (${leaderboard.length} –∑–∞–ø–∏—Å–µ–π)`);
                return leaderboard;
                
            } catch (error) {
                console.error(`‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–µ–π—Ç–∏–Ω–≥–∞ —Å GitHub:`, error.message);
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫—É –Ω–æ –Ω–µ –ø–∞–¥–∞–µ–º
                throw error;
            }
        }

        /**
         * –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –Ω–æ–≤—ã–π —Å–∫–æ—Ä –Ω–∞ GitHub —á–µ—Ä–µ–∑ Vercel Function
         */
        async function addScore(playerName, score, level) {
            if (!playerName.trim()) return;

            try {
                console.log(`üéØ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–∫–æ—Ä: ${playerName} - ${score} –æ—á–∫–æ–≤ (–£—Ä–æ–≤–µ–Ω—å ${level})`);

                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ Vercel Function
                const response = await fetch('/api/save-score', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        name: playerName.trim(),
                        score: score,
                        level: level
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Unknown error');
                }

                const result = await response.json();
                console.log(`‚úÖ –°–∫–æ—Ä —Å–æ—Ö—Ä–∞–Ω–µ–Ω! –ü–æ–∑–∏—Ü–∏—è: #${result.topScores?.findIndex(s => s.name === playerName) + 1 || '?'}`);

                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—Ö–µ
                showScoreSaveNotification(playerName, score, result.topScores?.findIndex(s => s.name === playerName) + 1);

            } catch (error) {
                console.error(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —Å–∫–æ—Ä–∞:`, error.message);
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫—É –Ω–æ –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º (–æ—Ñ—Ñ–ª–∞–π–Ω —Ä–µ–∂–∏–º)
                showScoreSaveError(error.message);
            }
        }

        /**
         * –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—à–Ω–æ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏
         */
        function showScoreSaveNotification(playerName, score, position) {
            playSound('button');
            // –£–∂–µ –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –ø–∞–Ω–µ–ª—å –≤–≤–æ–¥–∞ –≤ saveScore()
            console.log(`üèÜ ${playerName} –∑–∞–Ω—è–ª –º–µ—Å—Ç–æ #${position} –≤ —Ä–µ–π—Ç–∏–Ω–≥–µ —Å ${score} –æ—á–∫–∞–º–∏!`);
        }

        /**
         * –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ (–Ω–æ –∏–≥—Ä–∞ –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å)
         */
        function showScoreSaveError(errorMessage) {
            console.warn(`‚ö†Ô∏è –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–∫–æ—Ä–∞ –Ω–∞ —Ä–µ–π—Ç–∏–Ω–≥. –°–∫–æ—Ä –ù–ï —Å–æ—Ö—Ä–∞–Ω–µ–Ω: ${errorMessage}`);
            // –ù–µ –±–ª–æ–∫–∏—Ä—É–µ–º –∏–≥—Ä—É, –ø—Ä–æ—Å—Ç–æ –ª–æ–≥–∏—Ä—É–µ–º
        }

        async function displayLeaderboard() {
            const content = DOM.leaderboardContent;
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
            content.innerHTML = '<p style="text-align: center; opacity: 0.7;">‚è≥ –ó–∞–≥—Ä—É–∂–∞–µ–º —Ä–µ–π—Ç–∏–Ω–≥...</p>';

            try {
                const leaderboard = await getLeaderboard();

                if (leaderboard.length === 0) {
                    content.innerHTML = '<p style="text-align: center; opacity: 0.7;">–†–µ–π—Ç–∏–Ω–≥ –ø—É—Å—Ç. –ë—É–¥—å –ø–µ—Ä–≤—ã–º! üéØ</p>';
                    return;
                }

                // ‚≠ê v3.6.0: –ö—Ä–∞—Å–∏–≤—ã–π —Ä–µ–π—Ç–∏–Ω–≥ —Å –º–µ–¥–∞–ª—è–º–∏ –∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π
                let html = '<div style="font-family: monospace; max-height: 500px; overflow-y: auto;">';
                
                leaderboard.slice(0, 50).forEach((entry, index) => {
                    const medal = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : `${String(index + 1).padStart(2, ' ')}.`;
                    const levelBadge = `Lv.${String(entry.level).padStart(2, ' ')}`;
                    const isNewScore = entry.date === new Date().toISOString().split('T')[0] ? ' ‚≠ê' : '';
                    
                    html += `<div style="
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        padding: 12px 10px;
                        margin: 6px 0;
                        background: ${index < 3 ? 'rgba(255, 215, 61, 0.15)' : 'rgba(255, 255, 255, 0.08)'};
                        border-radius: 8px;
                        border-left: 3px solid ${index === 0 ? '#FFD93D' : index === 1 ? '#C0C0C0' : index === 2 ? '#CD7F32' : '#666'};
                        transition: all 0.3s ease;
                    " onmouseover="this.style.background = 'rgba(255, 255, 255, 0.15)'" 
                       onmouseout="this.style.background = '${index < 3 ? 'rgba(255, 215, 61, 0.15)' : 'rgba(255, 255, 255, 0.08)'}'">
                        <div style="flex: 1;">
                            <span style="font-weight: bold; font-size: 16px;">${medal} ${entry.name.substring(0, 20)}</span>
                            <span style="font-size: 11px; opacity: 0.6; margin-left: 10px;">${levelBadge}</span>
                        </div>
                        <div style="text-align: right;">
                            <div style="color: #FFD93D; font-weight: bold; font-size: 14px;">${entry.score}${isNewScore}</div>
                            <div style="font-size: 10px; opacity: 0.5; margin-top: 2px;">${entry.date}</div>
                        </div>
                    </div>`;
                });

                // –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏
                html += '<div style="text-align: center; margin-top: 15px; opacity: 0.5; font-size: 10px;">';
                html += `üì° Data: GitHub (source) ‚Üí Vercel Function (updates) ‚Üí Vercel (served)<br>`;
                html += `–í—Å–µ–≥–æ –∑–∞–ø–∏—Å–µ–π: ${leaderboard.length} ‚Ä¢ –†–µ–∞–ª-—Ç–∞–π–º —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è<br>`;
                html += `v${GAME_VERSION}`;
                html += '</div></div>';
                
                content.innerHTML = html;
                console.log(`üìä –†–µ–π—Ç–∏–Ω–≥ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω (${leaderboard.length} –∑–∞–ø–∏—Å–µ–π)`);

            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ä–µ–π—Ç–∏–Ω–≥–∞:', error);
                content.innerHTML = `<p style="text-align: center; opacity: 0.7;">‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–µ–π—Ç–∏–Ω–≥–∞<br><small>${error.message}</small></p>`;
            }
        }

        async function showLeaderboard() {
            playSound('button');
            leaderboardSource = 'gameOver';  // Track source
            DOM.gameOverScreen.style.display = 'none';
            DOM.leaderboardScreen.style.display = 'flex';
            // ‚≠ê v3.6.0: –ó–∞–≥—Ä—É–∂–∞–µ–º —Ä–µ–π—Ç–∏–Ω–≥ –∏–∑ GitHub –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ
            await displayLeaderboard();
        }

        async function showLeaderboardFromMenu() {
            playSound('button');
            leaderboardSource = 'menu';  // Track source
            DOM.menuScreen.style.display = 'none';
            DOM.leaderboardScreen.style.display = 'flex';
            // ‚≠ê v3.7.0: –ó–∞–≥—Ä—É–∂–∞–µ–º —Ä–µ–π—Ç–∏–Ω–≥ –∏–∑ GitHub –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ (–∏–∑ –º–µ–Ω—é)
            await displayLeaderboard();
        }

        function hideLeaderboard() {
            playSound('button');
            DOM.leaderboardScreen.style.display = 'none';
            // ‚≠ê v3.7.0: Return to the correct screen based on where we came from
            if (leaderboardSource === 'menu') {
                DOM.menuScreen.style.display = 'flex';
            } else {
                DOM.gameOverScreen.style.display = 'flex';
            }
        }

        async function saveScore() {
            const playerName = DOM.playerName.value;
            if (playerName.trim()) {
                playSound('button');
                // ‚≠ê v3.6.0: –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–∫–æ—Ä –Ω–∞ GitHub (–∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ)
                await addScore(playerName, gameState.score, gameState.currentLevel);
                skipScoreSave();
            }
        }

        function skipScoreSave() {
            playSound('button');
            DOM.scoreInputPanel.style.display = 'none';
            DOM.playerName.value = '';
        }

        // –£–î–ê–õ–ï–ù–û: displayGameStats() - –±–æ–ª—å—à–µ –Ω–µ –Ω—É–∂–Ω–∞, HTML —Å—Ç—Ä–æ–∏—Ç—Å—è –ø—Ä—è–º–æ –≤ game loop
        // –§—É–Ω–∫—Ü–∏—è –±—ã–ª–∞ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–º –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–≥–æ –∑–∞–≤–∏—Å–∞–Ω–∏—è —á–µ—Ä–µ–∑ setTimeout

        // ‚≠ê v3.7.0: Track where leaderboard was opened from (menu or gameOver)
        let leaderboardSource = null;

        // ==================== –°–û–°–¢–û–Ø–ù–ò–ï ====================
        let gameState = {
            isRunning: false,
            isPaused: false,
            currentLevel: 1,
            score: 0,
            mice: [],
            cats: [],
            cheese: [],
            obstacles: [],
            particles: null,
            burrows: [],
            traps: [],
            canvas: null,
            ctx: null,
            selectedMouse: 0,
            allCheese: 0,
            collectedCheese: 0,
            globalNoise: 0,
            backgroundGradient: null,
            audioContext: null,
            grid: null,
            fps: 60,
            // ‚≠ê v3.6.0: –ö—ç—à DOM —ç–ª–µ–º–µ–Ω—Ç–æ–≤ (–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è –æ–¥–∏–Ω —Ä–∞–∑, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è 60—Ö/—Å–µ–∫)
            domCache: {
                miceCount: null,
                miceHP: null,
                cheeseCount: null,
                totalCheese: null,
                levelNumber: null,
                stamina: null,
                fps: null,
            }
        };

        // ==================== INPUT SYSTEM v3.0 ====================
        // ‚≠ê –ü–û–õ–ù–ê–Ø –ü–ï–†–ï–†–ê–ë–û–¢–ö–ê - –¢–†–ò –ò–ó–û–õ–ò–†–û–í–ê–ù–ù–´–ï –°–ò–°–¢–ï–ú–´ –í–í–û–î–ê

        // –°—Ç–∞—Ä—ã–π –æ–±—ä–µ–∫—Ç - –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
        let input = { keys: {}, mouse: { x: 0, y: 0 } };

        // –°–ò–°–¢–ï–ú–ê 1: DESKTOP INPUT - –¢–æ–ª—å–∫–æ –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞
        let inputDesktop = {
            keys: {}  // { 'w': true, 'ArrowUp': true, ... }
        };

        // –°–ò–°–¢–ï–ú–ê 2: GAMEPAD INPUT - –¢–æ–ª—å–∫–æ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä PS4 —Å –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ–º
        let inputGamepad = {
            keys: {},              // { 'ArrowUp': true, 'Shift': true, ... }
            previousState: {},     // –î–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π —Å—Ç–∏–∫–∞
            stickPosition: {        // –¢–µ–∫—É—â–µ–µ –ø–æ–ª–æ–∂–µ–Ω–∏–µ —Å—Ç–∏–∫–∞
                x: 0,
                y: 0
            }
        };

        // –°–ò–°–¢–ï–ú–ê 3: MOBILE INPUT - –¢–æ–ª—å–∫–æ touch –∫–Ω–æ–ø–∫–∏
        let inputMobile = {
            keys: {}  // { 'ArrowUp': true, 'Space': true, ... }
        };

        // ‚≠ê –§–£–ù–ö–¶–ò–Ø –û–ë–™–ï–î–ò–ù–ï–ù–ò–Ø - –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã –¥–ª—è –∏–≥—Ä—ã
        function getMergedInput() {
            // –û–±—ä–µ–¥–∏–Ω—è–µ–º –≤—Å–µ —Ç—Ä–∏ –∫–∞–Ω–∞–ª–∞ –≤ –æ–¥–∏–Ω
            const merged = {};

            // –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ (Desktop)
            for (let key in inputDesktop.keys) {
                if (inputDesktop.keys[key]) merged[key] = true;
            }

            // –ö–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä (Gamepad) - –º–æ–∂–µ—Ç –ø–µ—Ä–µ–∫—Ä—ã—Ç—å keyboard
            for (let key in inputGamepad.keys) {
                if (inputGamepad.keys[key]) merged[key] = true;
            }

            // –ú–æ–±–∏–ª—å–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ (Mobile) - –º–æ–∂–µ—Ç –ø–µ—Ä–µ–∫—Ä—ã—Ç—å –æ–±–∞
            for (let key in inputMobile.keys) {
                if (inputMobile.keys[key]) merged[key] = true;
            }

            // ‚≠ê v3.6.0: –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ä—ã–π input.keys –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å –æ—Å—Ç–∞–ª—å–Ω—ã–º –∫–æ–¥–æ–º
            input.keys = merged;
            return input;  // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –≤ –ø—Ä–µ–∂–Ω–µ–º —Ñ–æ—Ä–º–∞—Ç–µ
        }

        // ‚≠ê –§–£–ù–ö–¶–ò–Ø –ë–ï–ó–û–ü–ê–°–ù–û–ô –û–ß–ò–°–¢–ö–ò - –≤–º–µ—Å—Ç–æ input.keys = {}
        function clearAllInput() {
            const hadInput = Object.keys(inputDesktop.keys).length > 0 ||
                           Object.keys(inputGamepad.keys).length > 0 ||
                           Object.keys(inputMobile.keys).length > 0;
            if (hadInput) {
                console.log('üßπ clearAllInput called, clearing state:', {
                    desktop: Object.keys(inputDesktop.keys).filter(k => inputDesktop.keys[k]),
                    gamepad: Object.keys(inputGamepad.keys).filter(k => inputGamepad.keys[k]),
                    mobile: Object.keys(inputMobile.keys).filter(k => inputMobile.keys[k])
                });
            }

            // –û—á–∏—â–∞–µ–º –≤—Å–µ –∫–ª—é—á–∏ –ë–ï–ó —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞ (–≤–∞–∂–Ω–æ –¥–ª—è —Å—Å—ã–ª–æ–∫)
            for (let key in inputDesktop.keys) {
                inputDesktop.keys[key] = false;
            }
            for (let key in inputGamepad.keys) {
                inputGamepad.keys[key] = false;
            }
            for (let key in inputMobile.keys) {
                inputMobile.keys[key] = false;
            }
        }

        let fpsFrames = 0, lastFpsTime = 0;
        let audioEnabled = true;  // ‚≠ê v3.6.0: –§–ª–∞–≥ –¥–ª—è toggle –∑–≤—É–∫–∞
        let audioResumeListenersSetup = false;
        let audioResumePromise = null;  // ‚≠ê v3.6.0: –ü–æ–º–Ω–∏–º Promise –æ—Ç resume() –¥–ª—è Safari

        // ==================== –ó–í–£–ö–ò ====================
        // ‚≠ê v3.6.0: –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∞—É–¥–∏–æ - –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç Promise –¥–ª—è Safari compatibility
        function initAudio(forceResume = false) {
            if (!gameState.audioContext) {
                try {
                    const AudioContextClass = window.AudioContext || window.webkitAudioContext || window.mozAudioContext;
                    if (!AudioContextClass) {
                        console.error('üî¥ Web Audio API –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è');
                        return Promise.resolve(null);
                    }
                    gameState.audioContext = new AudioContextClass();
                    console.log(`‚úÖ AudioContext —Å–æ–∑–¥–∞–Ω (${gameState.audioContext.constructor.name}), state: ${gameState.audioContext.state}`);

                    // ‚≠ê v3.6.0: –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º Safari iOS –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ context
                    unmuteIOSSafari();

                    if (gameState.audioContext.state === 'suspended') {
                        console.log('‚ö†Ô∏è AudioContext suspended - resuming...');
                        audioResumePromise = gameState.audioContext.resume().then(() => {
                            console.log(`‚úÖ AudioContext resumed! State: ${gameState.audioContext.state}`);
                            return gameState.audioContext;
                        }).catch(e => {
                            console.error(`‚ùå Resume failed: ${e.message}`);
                            return gameState.audioContext;
                        });
                        return audioResumePromise;
                    }

                    if (!audioResumeListenersSetup) {
                        setupAudioGestureListeners();
                    }
                } catch (e) {
                    console.error('üî¥ Audio init error:', e.message);
                    return Promise.resolve(null);
                }
            }

            if (forceResume && gameState.audioContext && gameState.audioContext.state === 'suspended') {
                audioResumePromise = gameState.audioContext.resume().catch(e => {
                    console.error(`‚ùå Resume failed: ${e.message}`);
                });
                return audioResumePromise || Promise.resolve(gameState.audioContext);
            }

            return Promise.resolve(gameState.audioContext);
        }

        // ‚≠ê v3.6.0: Setup —Å–ª—É—à–∞—Ç–µ–ª–∏ –¥–ª—è –≤–æ–∑–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
        function setupAudioGestureListeners() {
            if (audioResumeListenersSetup) return;
            audioResumeListenersSetup = true;

            const resumeIfNeeded = () => {
                // ‚≠ê v3.6.0: –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º Safari iOS –ø—Ä–∏ –ª—é–±–æ–º gesture
                unmuteIOSSafari();

                if (gameState.audioContext && gameState.audioContext.state === 'suspended') {
                    console.log('üîä Resuming from gesture listener...');
                    audioResumePromise = gameState.audioContext.resume().catch(e => {
                        console.error(`‚ùå Resume failed: ${e.message}`);
                    });
                }
            };

            document.addEventListener('click', resumeIfNeeded);
            document.addEventListener('keydown', resumeIfNeeded);
            document.addEventListener('touchstart', resumeIfNeeded);
            console.log('‚úÖ Audio listeners ready');
        }

        // ‚≠ê v3.6.0: Toggle –∑–≤—É–∫–∞
        // ‚≠ê v3.6.0: –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ Web Audio –Ω–∞ iOS Safari (mute switch –ø—Ä–æ–±–ª–µ–º–∞)
        function unmuteIOSSafari() {
            const silentAudio = DOM.silentAudio;
            if (silentAudio) {
                silentAudio.play().catch(e => {
                    console.log('üîá iOS unmute attempt:', e.message);
                });
            }
        }

        function toggleAudio() {
            audioEnabled = !audioEnabled;
            console.log(`üîä Audio ${audioEnabled ? 'ENABLED' : 'DISABLED'}`);

            if (audioEnabled) {
                // ‚≠ê v3.6.0: –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º Safari iOS –ø—Ä–∏ –≤–∫–ª—é—á–µ–Ω–∏–∏ –∑–≤—É–∫–∞
                unmuteIOSSafari();
                if (gameState.audioContext && gameState.audioContext.state === 'suspended') {
                    initAudio(true);
                }
            }

            const btn = DOM.audioToggleBtn;
            if (btn) {
                btn.textContent = audioEnabled ? 'üîä' : 'üîá';
                btn.style.opacity = audioEnabled ? '1' : '0.5';
            }

            return audioEnabled;
        }

        // ‚≠ê v3.6.0: –ó–í–£–ö–û–í–´–ï –ì–ï–ù–ï–†–ê–¢–û–†–´ - –∫–∞–∂–¥—ã–π –∑–≤—É–∫ –∫–∞–∫ —Ñ—É–Ω–∫—Ü–∏—è –≤–º–µ—Å—Ç–æ switch-case
        const SOUND_GENERATORS = {
            // ========== –°–´–†–ê - –≤–µ—Å—ë–ª—ã–π –≤—ã—Å–æ–∫–∏–π –∑–≤—É–∫ ==========
            cheese: (ctx) => {
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                osc.connect(gain);
                gain.connect(ctx.destination);
                osc.frequency.value = 950;
                gain.gain.setValueAtTime(0.25, ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.15);
                osc.start(ctx.currentTime);
                osc.stop(ctx.currentTime + 0.15);
            },

            // ========== –£–†–û–ù –û–¢ –ö–û–¢–ê - —Ç—Ä–µ–≤–æ–∂–Ω—ã–π —Å–∫—Ä–∏–ø ==========
            damage: (ctx) => {
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                osc.connect(gain);
                gain.connect(ctx.destination);
                osc.frequency.setValueAtTime(600, ctx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(350, ctx.currentTime + 0.15);
                gain.gain.setValueAtTime(0.3, ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.15);
                osc.start(ctx.currentTime);
                osc.stop(ctx.currentTime + 0.15);
            },

            // ========== –û–ü–ê–°–ù–û–°–¢–¨ (–∫–æ—Ç —Å–ª—ã—à–∏—Ç) - –±—ã—Å—Ç—Ä—ã–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–∞—é—â–∏–µ –∑–≤—É–∫–∏ ==========
            danger: (ctx) => {
                for (let i = 0; i < 2; i++) {
                    setTimeout(() => {
                        const osc = ctx.createOscillator();
                        const gain = ctx.createGain();
                        osc.connect(gain);
                        gain.connect(ctx.destination);
                        osc.frequency.value = 700 + (i * 100);
                        gain.gain.setValueAtTime(0.2, ctx.currentTime);
                        gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.08);
                        osc.start(ctx.currentTime);
                        osc.stop(ctx.currentTime + 0.08);
                    }, i * 100);
                }
            },

            // ========== –ü–†–Ø–¢–ö–ê –í –ù–û–†–ö–ï - —Å–ø–æ–∫–æ–π–Ω—ã–π, —É—é—Ç–Ω—ã–π –∑–≤—É–∫ ==========
            burrow: (ctx) => {
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                osc.connect(gain);
                gain.connect(ctx.destination);
                osc.frequency.setValueAtTime(300, ctx.currentTime);
                osc.frequency.linearRampToValueAtTime(400, ctx.currentTime + 0.3);
                gain.gain.setValueAtTime(0.15, ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.02, ctx.currentTime + 0.3);
                osc.start(ctx.currentTime);
                osc.stop(ctx.currentTime + 0.3);
            },

            // ========== –ö–õ–ò–ö –ö–ù–û–ü–ö–ò - –ø–æ–∑–∏—Ç–∏–≤–Ω—ã–π —â–µ–ª—á–æ–∫ ==========
            button: (ctx) => {
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                osc.connect(gain);
                gain.connect(ctx.destination);
                osc.frequency.value = 550;
                gain.gain.setValueAtTime(0.2, ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.12);
                osc.start(ctx.currentTime);
                osc.stop(ctx.currentTime + 0.12);
            },

            // ========== –ú–´–®–ï–õ–û–í–ö–ê - –æ–ø–∞—Å–Ω—ã–π –∑–≤—É–∫ ==========
            trap: (ctx) => {
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                osc.connect(gain);
                gain.connect(ctx.destination);
                osc.frequency.setValueAtTime(200, ctx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(150, ctx.currentTime + 0.2);
                gain.gain.setValueAtTime(0.35, ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.2);
                osc.start(ctx.currentTime);
                osc.stop(ctx.currentTime + 0.2);
            },

            // ========== –ü–ê–£–ó–ê - –Ω–µ–π—Ç—Ä–∞–ª—å–Ω—ã–π —â–µ–ª—á–æ–∫ ==========
            pause: (ctx) => {
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                osc.connect(gain);
                gain.connect(ctx.destination);
                osc.frequency.value = 450;
                gain.gain.setValueAtTime(0.15, ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.1);
                osc.start(ctx.currentTime);
                osc.stop(ctx.currentTime + 0.1);
            },

            // ========== –ú–ï–ù–Æ - –º—è–≥–∫–∏–π –∑–≤—É–∫ –æ—Ç–∫—Ä—ã—Ç–∏—è ==========
            menu: (ctx) => {
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                osc.connect(gain);
                gain.connect(ctx.destination);
                osc.frequency.setValueAtTime(350, ctx.currentTime);
                osc.frequency.linearRampToValueAtTime(500, ctx.currentTime + 0.25);
                gain.gain.setValueAtTime(0.12, ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.25);
                osc.start(ctx.currentTime);
                osc.stop(ctx.currentTime + 0.25);
            },

            // ========== –ö–û–ù–ï–¶ –£–†–û–í–ù–Ø - —ç–ø–∏—á–µ—Å–∫–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ ==========
            level: (ctx) => {
                const notes = [400, 500, 600, 700];
                for (let i = 0; i < notes.length; i++) {
                    setTimeout(() => {
                        const osc = ctx.createOscillator();
                        const gain = ctx.createGain();
                        osc.connect(gain);
                        gain.connect(ctx.destination);
                        osc.frequency.value = notes[i];
                        gain.gain.setValueAtTime(0.12, ctx.currentTime);
                        gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.12);
                        osc.start(ctx.currentTime);
                        osc.stop(ctx.currentTime + 0.12);
                    }, i * 80);
                }
            },

            // ========== –ò–ì–†–ê –û–ö–û–ù–ß–ï–ù–ê - –≥—Ä—É—Å—Ç–Ω—ã–π –∑–≤—É–∫ ==========
            gameOver: (ctx) => {
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                osc.connect(gain);
                gain.connect(ctx.destination);
                osc.frequency.setValueAtTime(500, ctx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(200, ctx.currentTime + 0.5);
                gain.gain.setValueAtTime(0.25, ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.5);
                osc.start(ctx.currentTime);
                osc.stop(ctx.currentTime + 0.5);
            },

            // ========== –ü–û–ë–ï–î–ê - –ø—Ä–∞–∑–¥–Ω–∏—á–Ω—ã–π –∑–≤—É–∫ ==========
            victory: (ctx) => {
                const notes = [600, 700, 800, 900];
                for (let i = 0; i < notes.length; i++) {
                    setTimeout(() => {
                        const osc = ctx.createOscillator();
                        const gain = ctx.createGain();
                        osc.connect(gain);
                        gain.connect(ctx.destination);
                        osc.frequency.value = notes[i];
                        gain.gain.setValueAtTime(0.15, ctx.currentTime);
                        gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.2);
                        osc.start(ctx.currentTime);
                        osc.stop(ctx.currentTime + 0.2);
                    }, i * 120);
                }
            },

            // ========== –ü–û–ü–ê–î–ê–ù–ò–ï –í –ö–û–ì–¢–ò (–ø–æ–π–º–∞–Ω–∞) - –≥—Ä–æ–º–∫–∏–π —É–¥–∞—Ä ==========
            caught: (ctx) => {
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                osc.connect(gain);
                gain.connect(ctx.destination);
                osc.frequency.setValueAtTime(250, ctx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(100, ctx.currentTime + 0.3);
                gain.gain.setValueAtTime(0.4, ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.3);
                osc.start(ctx.currentTime);
                osc.stop(ctx.currentTime + 0.3);
            }
        };

        function playSound(type) {
            if (!audioEnabled) return;

            const ctx = gameState.audioContext;
            if (!ctx) {
                console.log(`üîä AudioContext not ready yet (${type})`);
                return;
            }

            // ‚≠ê v3.6.0: –ï—Å–ª–∏ context suspended, –Ω–µ –ø—ã—Ç–∞–µ–º—Å—è –∏–≥—Ä–∞—Ç—å
            if (ctx.state === 'suspended') {
                console.log(`‚ö†Ô∏è AudioContext suspended, skipping sound (${type})`);
                return;
            }

            if (ctx.state !== 'running') {
                console.log(`‚ö†Ô∏è AudioContext state: ${ctx.state}, skipping sound (${type})`);
                return;
            }

            // ‚≠ê v3.6.0: –î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è Safari –¥–µ–±–∞–≥–∞
            console.log(`üéµ [${type}] ctx.state=${ctx.state}, sampleRate=${ctx.sampleRate}, currentTime=${ctx.currentTime}`);

            try {
                // ‚≠ê v3.6.0: –í—ã–∑–æ–≤ —Ñ—É–Ω–∫—Ü–∏–∏ –∏–∑ SOUND_GENERATORS –≤–º–µ—Å—Ç–æ switch-statement
                const generator = SOUND_GENERATORS[type];
                if (generator) {
                    generator(ctx);
                } else {
                    console.warn(`‚ö†Ô∏è Unknown sound type: ${type}`);
                }
            } catch (e) {
                // ‚≠ê v3.6.0: Log audio errors for debugging Safari issues
                console.error(`‚ùå Audio error (${type}):`, e.message);
            }
        }

        // ==================== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ====================
        function initGame() {
            console.log(`üìç initGame() - Level ${gameState.currentLevel}`);
            try {
                // –°–±—Ä–æ—Å —Å—á–µ—Ç—á–∏–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
                gameLoopSafetyCounter = 0;

                gameState.canvas = DOM.gameCanvas;
                if (!gameState.canvas) throw new Error('Canvas not found!');
                console.log('‚úÖ Canvas –Ω–∞–π–¥–µ–Ω');

                gameState.ctx = gameState.canvas.getContext('2d');
                if (!gameState.ctx) throw new Error('Canvas context failed!');
                console.log('‚úÖ Context –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');

                const levelConfig = getLevelConfig(gameState.currentLevel);
                console.log(`‚úÖ Level config –∑–∞–≥—Ä—É–∂–µ–Ω–∞: ${levelConfig.mice}–º, ${levelConfig.cats}–∫, ${levelConfig.cheese}—á`);

                // Responsive canvas sizing - use optimal size but respect level requirements
                const optimalSize = getOptimalCanvasSize();
                const canvasWidth = Math.min(levelConfig.roomWidth, optimalSize.width);
                const canvasHeight = Math.min(levelConfig.roomHeight, optimalSize.height);

                gameState.canvas.width = canvasWidth;
                gameState.canvas.height = canvasHeight;
                console.log(`‚úÖ Canvas —Ä–∞–∑–º–µ—Ä: ${canvasWidth}x${canvasHeight}`);
                console.log(`üì± Window —Ä–∞–∑–º–µ—Ä: ${window.innerWidth}x${window.innerHeight}`);
                console.log(`üìê Device pixel ratio: ${devicePixelRatio}x`);

                gameState.grid = new SpatialGrid(levelConfig.roomWidth, levelConfig.roomHeight, 100);
            gameState.particles = new ParticlePool(500);

            gameState.backgroundGradient = gameState.ctx.createLinearGradient(0, 0, gameState.canvas.width, gameState.canvas.height);
            gameState.backgroundGradient.addColorStop(0, '#FFE66D');
            gameState.backgroundGradient.addColorStop(0.5, '#F4F4F4');
            gameState.backgroundGradient.addColorStop(1, '#A8E6CF');

            gameState.mice = [];
            gameState.cats = [];
            gameState.cheese = [];
            gameState.obstacles = [];
            gameState.burrows = [];
            gameState.traps = [];
            gameState.collectedCheese = 0;
            gameState.allCheese = levelConfig.cheese;
            gameState.selectedMouse = 0;
            gameState.globalNoise = 0;

            // –ü—Ä–µ–ø—è—Ç—Å—Ç–≤–∏—è
            for (let i = 0; i < levelConfig.obstacles; i++) {
                let x, y;
                do {
                    x = 100 + Math.random() * (levelConfig.roomWidth - 200);
                    y = 100 + Math.random() * (levelConfig.roomHeight - 200);
                } while (!isSpawnSafe(x, y, gameState.obstacles, 120));
                const obs = new Obstacle(x, y, i);
                gameState.obstacles.push(obs);
                gameState.grid.insert('obstacles', x, y, obs);
            }

            // –ù–æ—Ä–∫–∏
            for (let i = 0; i < levelConfig.burrows; i++) {
                let x, y;
                do {
                    x = 100 + Math.random() * (levelConfig.roomWidth - 200);
                    y = 100 + Math.random() * (levelConfig.roomHeight - 200);
                } while (!isSpawnSafe(x, y, gameState.obstacles, 120) || !isSpawnSafe(x, y, gameState.burrows, 120));
                gameState.burrows.push(new Burrow(x, y));
            }

            // –ú—ã—à–µ–ª–æ–≤–∫–∏
            for (let i = 0; i < levelConfig.traps; i++) {
                let x, y;
                do {
                    x = 100 + Math.random() * (levelConfig.roomWidth - 200);
                    y = 100 + Math.random() * (levelConfig.roomHeight - 200);
                } while (!isSpawnSafe(x, y, gameState.obstacles, 100) || !isSpawnSafe(x, y, gameState.burrows, 120) || !isSpawnSafe(x, y, gameState.traps, 100));
                gameState.traps.push(new Trap(x, y));
            }

            // –ú—ã—à–∏
            for (let i = 0; i < levelConfig.mice; i++) {
                gameState.mice.push(new Mouse(120 + i * 80, 120 + i * 80));
            }

            // –ö–æ—à–∫–∏
            for (let i = 0; i < levelConfig.cats; i++) {
                gameState.cats.push(new Cat(
                    levelConfig.roomWidth - 120 - i * 80,
                    levelConfig.roomHeight - 120 - i * 80
                ));
            }

            // –°—ã—Ä
            for (let i = 0; i < levelConfig.cheese; i++) {
                let x, y;
                do {
                    x = 100 + Math.random() * (levelConfig.roomWidth - 200);
                    y = 100 + Math.random() * (levelConfig.roomHeight - 200);
                } while (!isSpawnSafe(x, y, gameState.obstacles, 100) || !isSpawnSafe(x, y, gameState.traps, 80));
                gameState.cheese.push(new Cheese(x, y));
            }

                console.log(`‚úÖ initGame –∑–∞–≤–µ—Ä—à–µ–Ω–∞: ${gameState.mice.length}–º, ${gameState.cats.length}–∫, ${gameState.cheese.length}—á`);
            } catch (e) {
                console.error('‚ùå ERROR in initGame:', e.message);
                console.error(e.stack);
                alert('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∏–≥—Ä—ã!\n' + e.message);
                gameState.isRunning = false;
                return;
            }

            updateUI();
            playSound('level');
        }

        // ==================== UI ====================
        function updateUI() {
            // –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï: –ù–ï –æ–±–Ω–æ–≤–ª—è–µ–º UI –µ—Å–ª–∏ –∏–≥—Ä–∞ –Ω–µ –∑–∞–ø—É—â–µ–Ω–∞
            if (!gameState.isRunning) return;

            try {
                // –ë—ã—Å—Ç—Ä–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å –º—ã—à–∏
                if (gameState.mice.length === 0) return;

                let aliveCount = 0;
                let mainHP = 0;

                // –ë—ã—Å—Ç—Ä—ã–π —Ü–∏–∫–ª –±–µ–∑ –∏–∑–ª–∏—à–Ω–∏—Ö –ø—Ä–æ–≤–µ—Ä–æ–∫
                const selectedIdx = gameState.selectedMouse;
                for (let i = 0; i < gameState.mice.length; i++) {
                    const m = gameState.mice[i];
                    if (m.alive) aliveCount++;
                    if (i === selectedIdx) mainHP = m.hp;
                }

                // ‚≠ê v3.6.0: –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã (–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã –≤ startGame)
                const cache = gameState.domCache;
                if (cache.miceCount) cache.miceCount.textContent = aliveCount;
                if (cache.miceHP) cache.miceHP.textContent = Math.round(mainHP);
                if (cache.cheeseCount) cache.cheeseCount.textContent = gameState.collectedCheese;
                if (cache.totalCheese) cache.totalCheese.textContent = gameState.allCheese;
                if (cache.levelNumber) cache.levelNumber.textContent = gameState.currentLevel;

                // –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è —Ä–∞–±–æ—Ç–∞ —Å–æ stamina
                const selectedMouse = gameState.mice[selectedIdx];
                if (cache.stamina && selectedMouse) {
                    cache.stamina.textContent = Math.round(selectedMouse.stamina || 0);
                }

                if (cache.fps) cache.fps.textContent = gameState.fps || 0;
            } catch (e) {
                console.log('updateUI –æ—à–∏–±–∫–∞ (–Ω–µ–∫—Ä–∏—Ç–∏—á–Ω–∞):', e);
                // –ù–µ –ø—Ä–µ—Ä—ã–≤–∞–µ–º game loop –∏–∑-–∑–∞ –æ—à–∏–±–∫–∏ –≤ UI
            }
        }

        // ==================== –ì–õ–ê–í–ù–û–ô –¶–ò–ö–õ ====================
        let lastGameOverTime = 0;
        let gameLoopSafetyCounter = 0;
        let lastFrameTime = performance.now();  // ‚≠ê v3.6.0: –î–ª—è deltaTime —Ä–∞—Å—á–µ—Ç–∞ (–∏—Å–ø—Ä–∞–≤–ª—è–µ—Ç —Å–∫–æ—Ä–æ—Å—Ç—å –Ω–∞ 120Hz —ç–∫—Ä–∞–Ω–∞—Ö)
        let lastMouseSwitchTime = 0;  // ‚≠ê v3.6.0: –î–ª—è debounce Tab –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è (300ms)

        function gameLoop() {
            if (!gameState.isRunning) return;

            if (gameState.isPaused) {
                requestAnimationFrame(gameLoop);
                return;
            }

            // –ó–∞—â–∏—Ç–∞ –æ—Ç infinite loop
            gameLoopSafetyCounter++;
            if (gameLoopSafetyCounter > 100000) {
                console.error('–ë–ï–ó–û–ü–ê–°–ù–û–°–¢–¨: –û–±–Ω–∞—Ä—É–∂–µ–Ω –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–π infinite loop');
                gameState.isRunning = false;
                return;
            }

            try {
                const now = performance.now();
                const deltaTime = Math.min((now - lastFrameTime) / 16.67, 2);  // ‚≠ê v3.6.0: –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º –∫ 60FPS (16.67ms per frame), –º–∞–∫—Å 2x –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
                lastFrameTime = now;

                fpsFrames++;
                if (now - lastFpsTime >= 1000) {
                    gameState.fps = fpsFrames;
                    fpsFrames = 0;
                    lastFpsTime = now;
                }

                gameState.ctx.fillStyle = gameState.backgroundGradient;
                gameState.ctx.fillRect(0, 0, gameState.canvas.width, gameState.canvas.height);

                // ‚≠ê v2.9.0: Update gamepad input every frame
                updateGamepadInput();

                // ‚≠ê v3.6.0: –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–Ø - –≤—ã—á–∏—Å–ª—è–µ–º merged input –û–î–ù –†–ê–ó –≤ gameLoop
                // (–≤–º–µ—Å—Ç–æ –≤—ã–∑–æ–≤–∞ –¥–ª—è –∫–∞–∂–¥–æ–π –º—ã—à–∏ 8 —Ä–∞–∑ –∑–∞ –∫–∞–¥—Ä)
                const mergedInput = getMergedInput();

                // ‚≠ê v3.6.0: –§–ò–ß–ê - –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –º—ã—à–∏ –Ω–∞ Tab (—Ä–∞–±–æ—Ç–∞–µ—Ç –∏ –Ω–∞ –∫–ª–∞–≤–∏–∞—Ç—É—Ä–µ –∏ –Ω–∞ –¥–∂–æ–π—Å—Ç–∏–∫–µ)
                if (mergedInput.keys['Tab'] && gameState.mice.length > 1 && now - lastMouseSwitchTime > 300) {
                    gameState.selectedMouse = (gameState.selectedMouse + 1) % gameState.mice.length;
                    let iterations = 0;
                    while (!gameState.mice[gameState.selectedMouse].alive && iterations < gameState.mice.length) {
                        gameState.selectedMouse = (gameState.selectedMouse + 1) % gameState.mice.length;
                        iterations++;
                    }
                    lastMouseSwitchTime = now;
                    console.log(`üê≠ –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞ –º—ã—à—å #${gameState.selectedMouse + 1}`);
                }

                // –û–±–Ω–æ–≤–ª–µ–Ω–∏—è
                // ‚≠ê v3.6.0: Mouse.update() –ø–æ–ª—É—á–∞–µ—Ç –∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–π mergedInput
                // ‚≠ê v3.6.0: –ü–µ—Ä–µ–¥–∞–µ–º deltaTime –¥–ª—è –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏ –¥–≤–∏–∂–µ–Ω–∏—è
                for (let i = gameState.mice.length - 1; i >= 0; i--) {
                    gameState.mice[i].update(gameState.grid, gameState, mergedInput, deltaTime);
                }
                for (let i = gameState.cats.length - 1; i >= 0; i--) {
                    gameState.cats[i].update(gameState, deltaTime);
                }
                for (let i = gameState.cheese.length - 1; i >= 0; i--) {
                    gameState.cheese[i].update(deltaTime);
                }
                gameState.particles.update();

                // ‚≠ê v3.6.0: globalNoise —Ç–∞–∫–∂–µ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç deltaTime
                gameState.globalNoise = Math.max(0, gameState.globalNoise - 0.8 * deltaTime);

                // –û—Ç—Ä–∏—Å–æ–≤–∫–∞
                for (let i = 0; i < gameState.obstacles.length; i++) {
                    gameState.obstacles[i].draw(gameState.ctx);
                }
                for (let i = 0; i < gameState.burrows.length; i++) {
                    gameState.burrows[i].draw(gameState.ctx);
                }
                for (let i = 0; i < gameState.traps.length; i++) {
                    gameState.traps[i].draw(gameState.ctx);
                }
                for (let i = 0; i < gameState.cheese.length; i++) {
                    gameState.cheese[i].draw(gameState.ctx);
                }
                for (let i = 0; i < gameState.cats.length; i++) {
                    gameState.cats[i].draw(gameState.ctx);
                }
                for (let i = 0; i < gameState.mice.length; i++) {
                    gameState.mice[i].draw(gameState.ctx);
                }

                gameState.particles.draw(gameState.ctx);

                // –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –ì–ê–†–ê–ù–¢–ò–Ø: globalAlpha –≤—Å–µ–≥–¥–∞ = 1 –≤ –∫–æ–Ω—Ü–µ –∫–∞–¥—Ä–∞
                gameState.ctx.globalAlpha = 1;
                gameState.ctx.fillStyle = '#000';

                updateUI();

                // –ü—Ä–æ–≤–µ—Ä–∫–∏ —É—Å–ª–æ–≤–∏–π - –¢–û–õ–¨–ö–û –µ—Å–ª–∏ –∏–≥—Ä–∞ –≤—Å–µ –µ—â–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
                if (!gameState.isRunning) {
                    // –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –∑–∞—â–∏—Ç–∞: –µ—Å–ª–∏ isRunning —Å—Ç–∞–ª false, –≤—ã—Ö–æ–¥–∏–º –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ
                    gameLoopSafetyCounter = 0;
                    return;
                }

                let aliveMice = 0;
                let lastAliveMouse = -1;  // –ò–Ω–¥–µ–∫—Å –ø–æ—Å–ª–µ–¥–Ω–µ–π –∂–∏–≤–æ–π –º—ã—à–∏
                for (let i = 0; i < gameState.mice.length; i++) {
                    if (gameState.mice[i].alive) {
                        aliveMice++;
                        lastAliveMouse = i;
                    }
                }

                // ‚≠ê v3.6.0: –§–ò–ß–ê - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞ –ø–æ—Å–ª–µ–¥–Ω—é—é –º—ã—à—å
                // –ï—Å–ª–∏ –æ—Å—Ç–∞–ª–∞—Å—å –æ–¥–Ω–∞ –∂–∏–≤–∞—è –º—ã—à—å –∏ —Ç–µ–∫—É—â–∞—è –º—ã—à—å –º–µ—Ä—Ç–≤–∞, –ø–µ—Ä–µ–∫–ª—é—á–∏–º—Å—è –Ω–∞ –∂–∏–≤—É—é
                if (aliveMice === 1 && lastAliveMouse !== -1) {
                    if (!gameState.mice[gameState.selectedMouse].alive) {
                        gameState.selectedMouse = lastAliveMouse;
                        console.log(`üê≠ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞ –ø–æ—Å–ª–µ–¥–Ω—é—é –º—ã—à—å #${lastAliveMouse + 1}`);
                    }
                }

                if (aliveMice === 0) {
                    // –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï: –ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ –æ—Ç–∫–ª—é—á–∞–µ–º —Ü–∏–∫–ª
                    gameState.isRunning = false;
                    gameLoopSafetyCounter = 0;
                    playSound('gameOver');

                    // ‚≠ê v3.6.0: –û—á–∏—â–∞–µ–º input state –ë–ï–ó–û–ü–ê–°–ù–û
                    clearAllInput();

                    // –°–æ–∑–¥–∞–µ–º —Å–Ω–∏–º–æ–∫ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏–≥—Ä—ã –î–û –ª—é–±—ã—Ö DOM –æ–ø–µ—Ä–∞—Ü–∏–π
                    const finalLevel = gameState.currentLevel;
                    const finalCheese = gameState.collectedCheese;
                    const finalAllCheese = gameState.allCheese;
                    const finalScore = gameState.score;

                    // –ù–ï –∏—Å–ø–æ–ª—å–∑—É–µ–º setTimeout - –æ–Ω –º–æ–∂–µ—Ç –≤—ã–∑–≤–∞—Ç—å –ø—Ä–æ–±–ª–µ–º—ã
                    // –í–º–µ—Å—Ç–æ —ç—Ç–æ–≥–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —ç–∫—Ä–∞–Ω game over —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ
                    try {
                        const textEl = DOM.gameOverText;
                        if (textEl) {
                            textEl.textContent = `–£—Ä–æ–≤–µ–Ω—å: ${finalLevel}\n–°—ã—Ä —Å–æ–±—Ä–∞–Ω: ${finalCheese}/${finalAllCheese}\n–û—á–∫–∏: ${finalScore}`;
                        }

                        const statsPanel = DOM.statsPanel;
                        if (statsPanel) {
                            // –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –±—ã—Å—Ç—Ä–æ–µ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ HTML
                            statsPanel.innerHTML = `
                                <div style="background:rgba(255,255,255,0.1);padding:15px;border-radius:10px;text-align:center;border:1px solid rgba(255,255,255,0.2);">
                                    <div style="font-size:28px;margin-bottom:5px;">üê≠</div>
                                    <div style="font-size:12px;opacity:0.7;">–ú—ã—à–∏ —Å–ø–∞—Å–µ–Ω—ã</div>
                                    <div style="font-size:24px;font-weight:bold;color:#FFD93D;">${aliveMice}</div>
                                </div>
                                <div style="background:rgba(255,255,255,0.1);padding:15px;border-radius:10px;text-align:center;border:1px solid rgba(255,255,255,0.2);">
                                    <div style="font-size:28px;margin-bottom:5px;">üßÄ</div>
                                    <div style="font-size:12px;opacity:0.7;">–°—ã—Ä —Å–æ–±—Ä–∞–Ω</div>
                                    <div style="font-size:24px;font-weight:bold;color:#FFD93D;">${finalCheese}/${finalAllCheese}</div>
                                </div>
                                <div style="background:rgba(255,255,255,0.1);padding:15px;border-radius:10px;text-align:center;border:1px solid rgba(255,255,255,0.2);">
                                    <div style="font-size:28px;margin-bottom:5px;">‚≠ê</div>
                                    <div style="font-size:12px;opacity:0.7;">–û—á–∫–∏</div>
                                    <div style="font-size:24px;font-weight:bold;color:#FFD93D;">${finalScore}</div>
                                </div>
                                <div style="background:rgba(255,255,255,0.1);padding:15px;border-radius:10px;text-align:center;border:1px solid rgba(255,255,255,0.2);">
                                    <div style="font-size:28px;margin-bottom:5px;">üìä</div>
                                    <div style="font-size:12px;opacity:0.7;">–£—Ä–æ–≤–µ–Ω—å</div>
                                    <div style="font-size:24px;font-weight:bold;color:#FFD93D;">${finalLevel}</div>
                                </div>
                            `;
                        }

                        showScreen('gameOver');
                    } catch (e) {
                        console.error('–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ game over:', e);
                    }

                    // –ü–û–õ–ù–ê–Ø –ì–ê–†–ê–ù–¢–ò–Ø: –Ω–µ –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º game loop
                    return;
                }

                if (gameState.cheese.length === 0 && gameState.allCheese > 0) {
                    // –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï: –ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ –æ—Ç–∫–ª—é—á–∞–µ–º —Ü–∏–∫–ª
                    gameState.isRunning = false;
                    gameLoopSafetyCounter = 0;
                    playSound('victory');

                    // ‚≠ê v3.6.0: –û—á–∏—â–∞–µ–º input state –ë–ï–ó–û–ü–ê–°–ù–û
                    clearAllInput();

                    // –°–æ–∑–¥–∞–µ–º —Å–Ω–∏–º–æ–∫ —Å–æ—Å—Ç–æ—è–Ω–∏—è –î–û –ª—é–±—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
                    const completeLevel = gameState.currentLevel;
                    const completeAliveMice = aliveMice;
                    const bonusPoints = aliveMice * 100;
                    const completeFinalScore = gameState.score + gameState.allCheese * (completeLevel * 10) + bonusPoints;

                    // –û–±–Ω–æ–≤–ª—è–µ–º score –≤ gameState
                    gameState.score = completeFinalScore;

                    // –°–∏–Ω—Ö—Ä–æ–Ω–Ω–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —ç–∫—Ä–∞–Ω
                    try {
                        const textEl = DOM.levelCompleteText;
                        if (textEl) {
                            textEl.textContent = `üéâ –£—Ä–æ–≤–µ–Ω—å ${completeLevel} –ø—Ä–æ–π–¥–µ–Ω!\n–ú—ã—à–∏ —Å–ø–∞—Å–µ–Ω—ã: ${completeAliveMice}\n–û—á–∫–∏: ${completeFinalScore}`;
                        }
                        showScreen('levelComplete');
                    } catch (e) {
                        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ level complete:', e);
                    }

                    // –ü–û–õ–ù–ê–Ø –ì–ê–†–ê–ù–¢–ò–Ø: –Ω–µ –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º game loop
                    return;
                }

                // –°–±—Ä–æ—Å —Å—á–µ—Ç—á–∏–∫–∞ –Ω–∞ –∫–∞–∂–¥—ã–π —É—Å–ø–µ—à–Ω—ã–π —Ü–∏–∫–ª
                gameLoopSafetyCounter = 0;
                requestAnimationFrame(gameLoop);
            } catch (e) {
                console.error('–ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê –≤ gameLoop:', e);
                gameState.isRunning = false;
                gameLoopSafetyCounter = 0;
                // –ü—Ä–æ–±—É–µ–º –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å—Å—è
                setTimeout(() => {
                    if (!gameState.isRunning) {
                        console.log('–ò–≥—Ä–∞ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –∏–∑-–∑–∞ –æ—à–∏–±–∫–∏');
                    }
                }, 100);
            }
        }

        // ==================== –£–ü–†–ê–í–õ–ï–ù–ò–ï ====================
        // Touch controls for mobile
        // ‚≠ê v3.6.0: MOBILE TOUCH CONTROLS - –ü–û–õ–ù–ê–Ø –ü–ï–†–ï–†–ê–ë–û–¢–ö–ê
        // –û–î–ò–ù LISTENER per BUTTON + –ò–ó–û–õ–Ø–¶–ò–Ø –ú–û–ë–ò–õ–ï–ô
        function setupTouchControls() {
            // ‚úÖ –¢–û–õ–¨–ö–û –î–õ–Ø –ú–û–ë–ò–õ–¨–ù–´–• –£–°–¢–†–û–ô–°–¢–í!
            if (!isMobileDevice()) {
                console.log('üíª Desktop mode - touch controls –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É—é—Ç—Å—è');
                return;
            }

            console.log('üì± –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è mobile touch controls...');

            const virtualControls = DOM.virtualControls;
            if (!virtualControls) {
                console.warn('‚ö†Ô∏è virtualControls –Ω–µ –Ω–∞–π–¥–µ–Ω');
                return;
            }

            const allButtons = virtualControls.querySelectorAll('[data-key]');
            console.log(`‚úÖ –ù–∞–π–¥–µ–Ω–æ ${allButtons.length} –º–æ–±–∏–ª—å–Ω—ã—Ö –∫–Ω–æ–ø–æ–∫`);

            allButtons.forEach(btn => {
                const key = btn.dataset.key;
                if (!key) return;

                // ‚úÖ –û–î–ò–ù HANDLER - pointerdown/up —Ä–∞–±–æ—Ç–∞–µ—Ç –¥–ª—è touch, mouse, pen
                // –ù–ï –∏—Å–ø–æ–ª—å–∑—É–µ–º touchstart/touchend/mousedown/mouseup/pointerdown/pointerup –æ—Ç–¥–µ–ª—å–Ω–æ!

                btn.addEventListener('pointerdown', (e) => {
                    // ‚úÖ –ü–ò–®–ï–ú –¢–û–õ–¨–ö–û –í inputMobile!
                    inputMobile.keys[key] = true;
                    // –í–∏–∑—É–∞–ª—å–Ω–∞—è –æ–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å
                    btn.style.transform = 'scale(0.95)';
                });

                btn.addEventListener('pointerup', (e) => {
                    // ‚úÖ –ü–ò–®–ï–ú –¢–û–õ–¨–ö–û –í inputMobile!
                    inputMobile.keys[key] = false;
                    // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∏–ª—å
                    btn.style.transform = 'scale(1)';
                });

                // pointercancel - –∫–æ–≥–¥–∞ –ø–∞–ª–µ—Ü —É—à–µ–ª –∑–∞ –≥—Ä–∞–Ω–∏—Ü—ã –∏–ª–∏ –ø—Ä–µ—Ä–≤–∞–Ω–æ
                btn.addEventListener('pointercancel', (e) => {
                    // ‚úÖ –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –æ—á–∏—â–µ–Ω–∏–µ
                    inputMobile.keys[key] = false;
                    btn.style.transform = 'scale(1)';
                });
            });

            console.log('‚úÖ Mobile touch controls –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã —É—Å–ø–µ—à–Ω–æ');
        }

        // ‚≠ê –ú–û–ë–ò–õ–¨–ù–ê–Ø –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–Ø –ú–ï–ù–Æ –ö–ù–û–ü–û–ö
        function setupMobileButtons() {
            console.log('üì± –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–æ–±–∏–ª—å–Ω—ã—Ö –∫–Ω–æ–ø–æ–∫...');
            const allButtons = document.querySelectorAll('.button');

            allButtons.forEach((btn, index) => {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ onclick –∞—Ç—Ä–∏–±—É—Ç —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
                if (!btn.onclick && !btn.getAttribute('onclick')) {
                    console.warn(`‚ö†Ô∏è –ö–Ω–æ–ø–∫–∞ ${index} –Ω–µ –∏–º–µ–µ—Ç onclick –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞!`);
                }

                // ‚≠ê v3.6.0: –ò—Å–ø–æ–ª—å–∑—É–µ–º pointerdown/up –≤–º–µ—Å—Ç–æ multiple touch events
                // –≠—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç –¥–ª—è touch, mouse –∏ pen –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ
                btn.addEventListener('pointerdown', (e) => {
                    btn.style.transform = 'scale(0.95)';
                });

                btn.addEventListener('pointerup', (e) => {
                    btn.style.transform = 'scale(1)';
                });

                btn.addEventListener('pointercancel', (e) => {
                    btn.style.transform = 'scale(1)';
                });

                // –£–±–µ–¥–∏–º—Å—è —á—Ç–æ –∫–Ω–æ–ø–∫–∞ –∏–º–µ–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è touch
                btn.style.WebkitTouchCallout = 'none';
                btn.style.WebkitUserSelect = 'none';
                btn.style.touchAction = 'manipulation';
            });

            console.log(`‚úÖ ${allButtons.length} –∫–Ω–æ–ø–æ–∫ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ –¥–ª—è –º–æ–±–∏–ª—è`);
        }

        // ‚≠ê v2.6.0: –ú–û–ë–ò–õ–¨–ù–ê–Ø –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–Ø - –û–†–ò–ï–ù–¢–ê–¶–ò–Ø –ò –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø
        function checkAndHandleOrientation() {
            const isMobile = isMobileDevice();
            const isLandscape = window.innerWidth > window.innerHeight;

            if (!isMobile) return;

            console.log(`üì± –û—Ä–∏–µ–Ω—Ç–∞—Ü–∏—è: ${isLandscape ? 'LANDSCAPE' : 'PORTRAIT'}`);

            const prompt = DOM.orientationPrompt;
            if (!prompt) return;

            if (!isLandscape) {
                prompt.style.display = 'flex';
                console.log('‚ö†Ô∏è –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–¥—Å–∫–∞–∑–∫—É –æ –ø–æ–≤–æ—Ä–æ—Ç–µ —ç–∫—Ä–∞–Ω–∞');
            } else {
                prompt.style.display = 'none';
                console.log('‚úÖ –õ–∞–Ω–¥—à–∞—Ñ—Ç –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏—è –∞–∫—Ç–∏–≤–Ω–∞');
            }
        }

        // ‚≠ê v3.6.0: –ú–û–ë–ò–õ–¨–ù–ê–Ø –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–Ø - –û–†–ò–ï–ù–¢–ê–¶–ò–Ø –ò UNIFIED EVENT HANDLING
        function initMobileOptimization() {
            if (!isMobileDevice()) {
                console.log('üíª Desktop —Ä–µ–∂–∏–º - –º–æ–±–∏–ª—å–Ω–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è');
                return;
            }

            console.log('üì± –ú–æ–±–∏–ª—å–Ω–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞');

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏—é –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
            checkAndHandleOrientation();

            // –°–ª—É—à–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏–∏
            window.addEventListener('orientationchange', checkAndHandleOrientation, false);
            window.addEventListener('resize', checkAndHandleOrientation, false);

            // ‚≠ê UNIFIED TOUCH PREVENTION: –í—Å–µ –≤ –æ–¥–Ω–æ–º listener
            let lastTouchTime = 0;
            document.addEventListener('touchmove', (e) => {
                // –û—Ç–∫–ª—é—á–∞–µ–º scroll –∫–æ–≥–¥–∞ –∏–≥—Ä–∞ –∑–∞–ø—É—â–µ–Ω–∞
                if (gameState.isRunning && (e.target === gameState.canvas || e.target.closest('#virtualControls'))) {
                    e.preventDefault();
                }
            }, { passive: false });

            document.addEventListener('touchstart', (e) => {
                const now = Date.now();

                // –û—Ç–∫–ª—é—á–∞–µ–º multi-touch zoom
                if (e.touches.length > 1) {
                    e.preventDefault();
                }

                // –û—Ç–∫–ª—é—á–∞–µ–º double-tap zoom
                if (now - lastTouchTime < 300 && e.touches.length === 1) {
                    e.preventDefault();
                }
                lastTouchTime = now;
            }, { passive: false });

            console.log('‚úÖ Mobile event listeners —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã (unified)');

            // ‚≠ê v3.6.0: CONSOLIDATED iOS/Safari specific fixes
            // Apply webkit styles to interactive elements
            document.querySelectorAll('.action-btn, button, input').forEach(el => {
                el.style.touchAction = 'manipulation';
                el.style.webkitTouchCallout = 'none';
                el.style.webkitUserSelect = 'none';
            });

            // Canvas setup for iOS
            const canvas = DOM.gameCanvas;
            if (canvas) {
                canvas.style.touchAction = 'none';
                canvas.style.webkitTouchCallout = 'none';
                canvas.style.transform = 'translateZ(0)';  // Force repaint on iOS
            }

            // Fix viewport on iPhone
            const viewport = DOM.viewportMeta;
            if (viewport) {
                viewport.setAttribute('content', 'width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no, maximum-scale=1.0, minimum-scale=1.0, minimal-ui');
            }
        }

        // ‚≠ê v2.6.0: –£–õ–£–ß–®–ï–ù–ù–ê–Ø –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ò–ì–†–´ –î–õ–Ø –ú–û–ë–ò–õ–´
        function initGameMobile() {
            console.log('üì± –ù–∞—á–∞–ª–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∏–≥—Ä—ã –¥–ª—è –º–æ–±–∏–ª—è...');

            try {
                // 1. –û—á–∏—â–∞–µ–º input state
                console.log('üîÑ –û—á–∏—Å—Ç–∫–∞ input state...');
                // ‚≠ê v3.6.0: –ò—Å–ø–æ–ª—å–∑—É–µ–º –±–µ–∑–æ–ø–∞—Å–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é –æ—á–∏—Å—Ç–∫–∏
                clearAllInput();

                // 2. –ü–æ–ª—É—á–∞–µ–º canvas
                console.log('üìê –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è canvas...');
                if (!gameState.canvas) {
                    gameState.canvas = DOM.gameCanvas;
                    if (!gameState.canvas) {
                        throw new Error('Canvas element not found!');
                    }
                }

                // 3. –ü–æ–ª—É—á–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç —Å fallback
                console.log('üé® –ü–æ–ª—É—á–µ–Ω–∏–µ canvas context...');
                if (!gameState.ctx) {
                    gameState.ctx = gameState.canvas.getContext('2d', {
                        alpha: true,
                        antialias: false,
                        willReadFrequently: false
                    });

                    if (!gameState.ctx) {
                        throw new Error('Canvas 2D context not supported');
                    }
                }

                // 4. –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Ñ–æ–∫—É—Å –Ω–∞ canvas –¥–ª—è –º–æ–±–∏–ª—ã
                console.log('üéØ –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Ñ–æ–∫—É—Å –Ω–∞ canvas...');
                gameState.canvas.focus?.();
                setTimeout(() => {
                    gameState.canvas.click?.();
                }, 100);

                // 5. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —É—Ä–æ–≤–µ–Ω—å
                console.log('üéÆ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —É—Ä–æ–≤–Ω—è...');
                const levelConfig = getLevelConfig(gameState.currentLevel);
                const optimalSize = getOptimalCanvasSize();

                const canvasWidth = Math.min(levelConfig.roomWidth, optimalSize.width);
                const canvasHeight = Math.min(levelConfig.roomHeight, optimalSize.height);

                gameState.canvas.width = canvasWidth;
                gameState.canvas.height = canvasHeight;

                console.log(`‚úÖ Canvas –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω: ${canvasWidth}x${canvasHeight}`);
                console.log(`üì± Window size: ${window.innerWidth}x${window.innerHeight}`);

                return true;
            } catch (e) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –º–æ–±–∏–ª—ã:', e.message);
                drawErrorOnCanvas(`–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:\n${e.message}`);
                return false;
            }
        }

        // ‚≠ê v2.6.0: –†–ò–°–û–í–ê–ù–ò–ï –û–®–ò–ë–û–ö –ù–ê CANVAS
        function drawErrorOnCanvas(errorMessage) {
            try {
                if (!gameState.canvas || !gameState.ctx) {
                    console.error('‚ùå Canvas not available for error display');
                    alert(errorMessage);
                    return;
                }

                const ctx = gameState.ctx;
                const canvas = gameState.canvas;

                // –†–∏—Å—É–µ–º —Ñ–æ–Ω –æ—à–∏–±–∫–∏
                ctx.fillStyle = 'rgba(0, 0, 0, 0.9)';
                ctx.fillRect(0, 0, canvas.width, canvas.height);

                // –†–∏—Å—É–µ–º —Ç–µ–∫—Å—Ç –æ—à–∏–±–∫–∏
                ctx.fillStyle = '#FF5252';
                ctx.font = 'bold 24px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';

                const lines = errorMessage.split('\n');
                const startY = canvas.height / 2 - (lines.length * 30) / 2;

                lines.forEach((line, index) => {
                    ctx.fillText(line, canvas.width / 2, startY + index * 30);
                });

                // –†–∏—Å—É–µ–º –ø–æ–¥—Å–∫–∞–∑–∫—É
                ctx.fillStyle = '#FFD93D';
                ctx.font = '16px Arial';
                ctx.fillText('–ù–∞–∂–º–∏ –∫–Ω–æ–ø–∫—É "RETRY" –Ω–∏–∂–µ –∏–ª–∏ –æ–±–Ω–æ–≤–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—É', canvas.width / 2, canvas.height - 40);

            } catch (e) {
                console.error('‚ùå Error drawing on canvas:', e.message);
            }
        }

        // Handle device orientation changes
        function handleOrientationChange() {
            const newOrientation = window.innerWidth > window.innerHeight ? 'landscape' : 'portrait';
            if (newOrientation !== lastOrientationCheck && gameState.isRunning) {
                lastOrientationCheck = newOrientation;
                // Re-initialize game with new canvas size
                initGame();
            }
        }

        // Orientation and resize events
        window.addEventListener('orientationchange', handleOrientationChange, false);
        window.addEventListener('resize', handleOrientationChange, false);

        // Prevent default touch behaviors for better mobile experience
        document.addEventListener('touchmove', (e) => {
            if (e.target === gameState.canvas) {
                e.preventDefault();
            }
        }, { passive: false });

        // ==================== GAMEPAD API (PS4 Controller Support) ====================
        // ‚≠ê v2.9.0: –ü–û–õ–ù–ê–Ø –ü–û–î–î–ï–†–ñ–ö–ê PS4 –ö–û–ù–¢–†–û–õ–õ–ï–†–ê

        let gamepadState = {
            connected: false,
            buttonMap: {
                0: 'Square',      // –ö–≤–∞–¥—Ä–∞—Ç - –°–ø—Ä–∏–Ω—Ç (Shift)
                1: 'Circle',      // –ö—Ä—É–∂–æ–∫ - –ù–æ—Ä–∫–∞ (E)
                2: 'Triangle',    // –¢—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫ - –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –º—ã—à—å (Tab)
                3: 'Cross',       // –ö—Ä–µ—Å—Ç - –ü–∞—É–∑–∞ (Space)
            },
            deadZone: 0.15  // 15% dead zone –¥–ª—è —Å—Ç–∏–∫–æ–≤
        };

        function updateGamepadInput() {
            // ‚≠ê v3.6.0: –ü–û–õ–ù–û–°–¢–¨–Æ –ü–ï–†–ï–†–ê–ë–û–¢–ê–ù–ù–´–ô GAMEPAD INPUT –° –û–¢–°–õ–ï–ñ–ò–í–ê–ù–ò–ï–ú –°–û–°–¢–û–Ø–ù–ò–Ø
            // –¢–µ–ø–µ—Ä—å –ü–†–ê–í–ò–õ–¨–ù–û –æ—á–∏—â–∞–µ—Ç –∫–ª—é—á–∏ –∫–æ–≥–¥–∞ —Å—Ç–∏–∫ –æ—Ç–ø—É—â–µ–Ω!
            try {
                if (!inputGamepad) return; // –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

                const gamepads = navigator.getGamepads ? navigator.getGamepads() : (navigator.webkitGetGamepads ? navigator.webkitGetGamepads() : []);

                // –ö–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä –æ—Ç–∫–ª—é—á–µ–Ω - –ü–û–õ–ù–û–°–¢–¨–Æ –û–ß–ò–°–¢–ò–¢–¨ –í–°–ï –ö–õ–Æ–ß–ò
                if (!gamepads || gamepads.length === 0) {
                    if (gamepadState.connected) {
                        gamepadState.connected = false;
                        updateControllerIndicator();
                        console.log('‚ùå –ö–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä –æ—Ç–∫–ª—é—á–µ–Ω');
                    }
                    // ‚úÖ –û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –∫–ª—é—á–∏ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞
                    inputGamepad.keys = {};
                    inputGamepad.previousState = {};
                    inputGamepad.stickPosition = { x: 0, y: 0 };
                    return;
                }

                const gamepad = gamepads[0];
                if (!gamepad) return;

                // –°—Ç–∞—Ç—É—Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
                if (!gamepadState.connected) {
                    gamepadState.connected = true;
                    console.log('‚úÖ –ö–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä –ø–æ–¥–∫–ª—é—á–µ–Ω:', gamepad.id);
                    playSound('button');
                    updateControllerIndicator();
                }

                // ‚≠ê –ù–û–í–´–ô –ü–û–î–•–û–î: –í—ã—á–∏—Å–ª–∏—Ç—å –ß–¢–û –î–û–õ–ñ–ù–û –ë–´–¢–¨ –°–ï–ô–ß–ê–°
                const newState = {};

                // –õ–ï–í–´–ô –°–¢–ò–ö
                const stickX = gamepad.axes[0] || 0;
                const stickY = gamepad.axes[1] || 0;
                const deadZone = 0.15;

                // –ó–∞–ø–æ–º–Ω–∏—Ç—å –ø–æ–ª–æ–∂–µ–Ω–∏–µ —Å—Ç–∏–∫–∞ (–¥–ª—è –æ—Ç–ª–∞–¥–∫–∏)
                inputGamepad.stickPosition.x = stickX;
                inputGamepad.stickPosition.y = stickY;

                // ‚úÖ –¢–ï–ü–ï–†–¨ –ü–†–ê–í–ò–õ–¨–ù–û: –¢–æ–ª—å–∫–æ –µ—Å–ª–∏ —Å—Ç–∏–∫ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å–º–µ—â–µ–Ω
                if (Math.abs(stickY) > deadZone) {
                    if (stickY < -0.3) newState['ArrowUp'] = true;
                    if (stickY > 0.3) newState['ArrowDown'] = true;
                }
                if (Math.abs(stickX) > deadZone) {
                    if (stickX < -0.3) newState['ArrowLeft'] = true;
                    if (stickX > 0.3) newState['ArrowRight'] = true;
                }

                // –ö–ù–û–ü–ö–ò
                // X –∫–Ω–æ–ø–∫–∞ - –ü–∞—É–∑–∞ –≤ –∏–≥—Ä–µ –ò–õ–ò Start Game –≤ –º–µ–Ω—é
                if (gamepad.buttons[0]?.pressed) {
                    const isMenuOpen = (DOM.menuScreen?.classList.contains('active')) === true;
                    if (isMenuOpen && !gameState.isRunning) {
                        startGame();  // ‚≠ê –ó–∞–ø—É—Å—Ç–∏—Ç—å –∏–≥—Ä—É —á–µ—Ä–µ–∑ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä
                    } else {
                        newState['Space'] = true;  // –ü–∞—É–∑–∞ –≤ –∏–≥—Ä–µ
                    }
                }
                if (gamepad.buttons[1]?.pressed) newState['e'] = true;       // O = –ù–æ—Ä–∫–∞
                if (gamepad.buttons[2]?.pressed) newState['Tab'] = true;     // ‚ñ≥ = –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å
                if (gamepad.buttons[3]?.pressed) newState['Shift'] = true;   // ‚ñ° = –°–ø—Ä–∏–Ω—Ç

                // ‚úÖ –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï: –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å inputGamepad.keys = newState
                // –¢–µ–ø–µ—Ä—å –∫–ª—é—á–∏ –∫–æ—Ç–æ—Ä—ã–µ –ù–ï –≤ newState –±—É–¥—É—Ç undefined, –Ω–µ true!
                inputGamepad.keys = newState;
                inputGamepad.previousState = newState;

                // –í–ò–ë–†–ê–¶–ò–Ø –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏
                if (gamepad.vibrationActuator && gameState.isRunning) {
                    if (gamepad.buttons[0]?.pressed || gamepad.buttons[1]?.pressed) {
                        try {
                            gamepad.vibrationActuator.playEffect('dual-rumble', {
                                startDelay: 0,
                                duration: 50,
                                weakMagnitude: 0.3,
                                strongMagnitude: 0.1
                            });
                        } catch (e) {}
                    }
                }
            } catch (error) {
                console.error('‚ö†Ô∏è –û—à–∏–±–∫–∞ gamepad:', error);
            }
        }

        function updateControllerIndicator() {
            const indicator = DOM.controllerIndicator;
            if (!indicator) {
                // –°–æ–∑–¥–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
                const div = document.createElement('div');
                div.id = 'controllerIndicator';
                div.style.cssText = `
                    position: fixed;
                    top: 10px;
                    right: 10px;
                    z-index: 1000;
                    padding: 8px 12px;
                    background: linear-gradient(135deg, rgba(100, 200, 255, 0.9), rgba(100, 150, 255, 0.7));
                    border: 2px solid rgba(150, 220, 255, 0.8);
                    border-radius: 6px;
                    color: white;
                    font-weight: bold;
                    font-size: 14px;
                    display: ${gamepadState.connected ? 'block' : 'none'};
                    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
                    transition: all 0.2s ease;
                `;
                div.textContent = 'üéÆ PS4 Connected';
                document.body.appendChild(div);
            } else {
                indicator.style.display = gamepadState.connected ? 'block' : 'none';
            }
        }

        // –°–ª—É—à–∞–µ–º —Å–æ–±—ã—Ç–∏—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è/–æ—Ç–∫–ª—é—á–µ–Ω–∏—è –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞
        window.addEventListener('gamepadconnected', (e) => {
            console.log('üéÆ Gamepad –ø–æ–¥–∫–ª—é—á–µ–Ω:', e.gamepad.id);
            gamepadState.connected = true;
            updateControllerIndicator();
            playSound('button');
        });

        window.addEventListener('gamepaddisconnected', (e) => {
            console.log('‚ùå Gamepad –æ—Ç–∫–ª—é—á–µ–Ω');
            gamepadState.connected = false;
            updateControllerIndicator();
        });

        // ==================== –ú–ï–ù–Æ –ù–ê–í–ò–ì–ê–¶–ò–Ø (v2.9.1) ====================
        // ‚≠ê –ù–ê–í–ò–ì–ê–¶–ò–Ø –ü–û –ú–ï–ù–Æ –° –ö–õ–ê–í–ò–ê–¢–£–†–´ –ò –ú–´–®–ö–ò

        let menuState = {
            currentScreen: 'menu',
            selectedButtonIndex: 0,
            visibleButtons: []
        };

        function getVisibleMenuButtons() {
            // –ü–æ–ª—É—á–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π —ç–∫—Ä–∞–Ω –º–µ–Ω—é
            const menuScreen = DOM.menuScreen;
            const pauseScreen = DOM.pauseScreen;
            const levelCompleteScreen = DOM.levelCompleteScreen;
            const gameOverScreen = DOM.gameOverScreen;
            const leaderboardScreen = DOM.leaderboardScreen;

            let activeScreen = null;
            let screenName = '';

            if (menuScreen && menuScreen.classList.contains('active')) {
                activeScreen = menuScreen;
                screenName = 'menu';
            } else if (pauseScreen && pauseScreen.classList.contains('active')) {
                activeScreen = pauseScreen;
                screenName = 'pause';
            } else if (levelCompleteScreen && levelCompleteScreen.classList.contains('active')) {
                activeScreen = levelCompleteScreen;
                screenName = 'levelComplete';
            } else if (gameOverScreen && gameOverScreen.classList.contains('active')) {
                activeScreen = gameOverScreen;
                screenName = 'gameOver';
            } else if (leaderboardScreen && leaderboardScreen.style.display !== 'none') {
                activeScreen = leaderboardScreen;
                screenName = 'leaderboard';
            }

            if (!activeScreen) return [];

            menuState.currentScreen = screenName;
            // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –≤–∏–¥–∏–º—ã–µ –∫–Ω–æ–ø–∫–∏ –≤ –∞–∫—Ç–∏–≤–Ω–æ–º —ç–∫—Ä–∞–Ω–µ
            const buttons = Array.from(activeScreen.querySelectorAll('.button')).filter(btn => {
                const style = window.getComputedStyle(btn);
                const isVisible = style.display !== 'none' && style.visibility !== 'hidden';
                return isVisible;
            });

            // ‚≠ê v3.6.0: DEBUG - –õ–æ–≥–∏—Ä—É–µ–º –Ω–∞–π–¥–µ–Ω–Ω—ã–µ –∫–Ω–æ–ø–∫–∏
            if (buttons.length === 0) {
                console.warn(`‚ö†Ô∏è –ú–µ–Ω—é ${screenName}: –ù–ï –ù–ê–ô–î–ï–ù–û –í–ò–î–ò–ú–´–• –ö–ù–û–ü–û–ö!`);
                // –î–ª—è –æ—Ç–ª–∞–¥–∫–∏ –ø–æ–ø—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ –í–°–ï –∫–Ω–æ–ø–∫–∏, –¥–∞–∂–µ —Å–∫—Ä—ã—Ç—ã–µ
                const allButtons = Array.from(activeScreen.querySelectorAll('.button'));
                console.log(`  –í—Å–µ–≥–æ –∫–Ω–æ–ø–æ–∫ –Ω–∞–π–¥–µ–Ω–æ: ${allButtons.length}`);
                allButtons.forEach((btn, idx) => {
                    const style = window.getComputedStyle(btn);
                    console.log(`  [${idx}] ${btn.textContent.trim().substring(0, 30)} - display:${style.display}, visibility:${style.visibility}`);
                });
            }

            return buttons;
        }

        function highlightMenuButton(index) {
            const buttons = getVisibleMenuButtons();
            if (buttons.length === 0) return;

            // –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º –∏–Ω–¥–µ–∫—Å
            index = ((index % buttons.length) + buttons.length) % buttons.length;
            menuState.selectedButtonIndex = index;

            // –°–Ω–∏–º–∞–µ–º –ø–æ–¥—Å–≤–µ—Ç–∫—É —Å–æ –≤—Å–µ—Ö –∫–Ω–æ–ø–æ–∫
            buttons.forEach((btn, i) => {
                if (i === index) {
                    btn.style.boxShadow = '0 0 20px rgba(255, 215, 61, 0.8), 0 4px 24px rgba(255, 255, 255, 0.6)';
                    btn.style.transform = 'scale(1.08)';
                    btn.focus();
                } else {
                    btn.style.boxShadow = '';
                    btn.style.transform = '';
                }
            });
        }

        function initMenuNavigation() {
            console.log('üéÆ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –ø–æ –º–µ–Ω—é');

            // –ü–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º –ø–µ—Ä–≤—É—é –∫–Ω–æ–ø–∫—É –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –º–µ–Ω—é
            setTimeout(() => {
                const buttons = getVisibleMenuButtons();
                if (buttons.length > 0) {
                    highlightMenuButton(0);
                }
            }, 100);
        }

        // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ mouseover –¥–ª—è –º—ã—à–∫–∏
        document.addEventListener('mouseover', (e) => {
            if (e.target.classList && e.target.classList.contains('button')) {
                const buttons = getVisibleMenuButtons();
                const index = buttons.indexOf(e.target);
                if (index >= 0) {
                    highlightMenuButton(index);
                }
            }
        });

        // ‚≠ê –ú–ï–ì–ê-–ü–†–û–°–¢–ê–Ø –ò –ù–ê–î–ï–ñ–ù–ê–Ø –°–ò–°–¢–ï–ú–ê –ö–õ–ê–í–ò–ê–¢–£–†–´ v3.1
        // 1Ô∏è‚É£ –°–ª—É—à–∞—Ç–µ–ª—å –í–°–ï–ì–î–ê –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç –í–°–ï –Ω–∞–∂–∞—Ç–∏—è
        // 2Ô∏è‚É£ –ü–∏—à–µ—Ç –≤ inputDesktop –¥–ª—è –≤—Å–µ—Ö –∫–ª–∞–≤–∏—à –ë–ï–ó —É—Å–ª–æ–≤–∏–π
        // 3Ô∏è‚É£ –°–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞ (–º–µ–Ω—é, –ø–∞—É–∑–∞) –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –û–¢–î–ï–õ–¨–ù–û

        function normalizeKeyName(key) {
            // –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ –∫–ª–∞–≤–∏—à–∏ - —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∫–∞–∫ –µ—Å—Ç—å
            if (key === ' ') return 'Space';
            if (key === 'Enter') return 'Enter';
            if (key === 'Shift') return 'Shift';
            if (key === 'Control') return 'Control';
            // Arrow Keys - —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∫–∞–∫ –µ—Å—Ç—å (ArrowUp, ArrowDown, –∏ —Ç.–¥.)
            if (key.startsWith('Arrow')) return key;
            // –í—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ - –≤ –Ω–∏–∂–Ω–∏–π —Ä–µ–≥–∏—Å—Ç—Ä (w, a, s, d, –∏ —Ç.–¥.)
            return key.toLowerCase();
        }

        // ‚≠ê KEYDOWN - –ü–†–û–°–¢–û–ô: –∑–∞–ø–∏—à–∏ –∫–ª—é—á –≤ inputDesktop
        document.addEventListener('keydown', (e) => {
            const keyName = normalizeKeyName(e.key);

            // ‚úÖ –ì–õ–ê–í–ù–û–ï: –í–°–ï–ì–î–ê –ø–∏—à–µ–º –≤ inputDesktop
            inputDesktop.keys[keyName] = true;

            // ‚≠ê –û–¢–î–ï–õ–¨–ù–ê–Ø –õ–û–ì–ò–ö–ê –î–õ–Ø –ú–ï–ù–Æ (–Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç –≤–≤–æ–¥)
            const menuScreen = DOM.menuScreen;
            const pauseScreen = DOM.pauseScreen;
            const levelCompleteScreen = DOM.levelCompleteScreen;
            const gameOverScreen = DOM.gameOverScreen;

            const isMenuOpen = (menuScreen && menuScreen.classList.contains('active')) ||
                              (pauseScreen && pauseScreen.classList.contains('active')) ||
                              (levelCompleteScreen && levelCompleteScreen.classList.contains('active')) ||
                              (gameOverScreen && gameOverScreen.classList.contains('active'));

            if (isMenuOpen) {
                if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    highlightMenuButton(menuState.selectedButtonIndex - 1);
                } else if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    highlightMenuButton(menuState.selectedButtonIndex + 1);
                } else if (e.key === 'Enter') {
                    e.preventDefault();
                    const buttons = getVisibleMenuButtons();
                    if (buttons.length > 0) {
                        buttons[menuState.selectedButtonIndex].click();
                        playSound('button');
                    }
                }
            }

            // ‚≠ê –°–ü–ï–¶–ò–ê–õ–¨–ù–´–ï –ö–õ–ê–í–ò–®–ò (—Ä–∞–±–æ—Ç–∞—é—Ç –í–°–ï–ì–î–ê, –Ω–µ –∑–∞–≤–∏—Å—è—Ç –æ—Ç —É—Å–ª–æ–≤–∏–π)
            if (e.key === ' ' && gameState.isRunning && !isMenuOpen) {
                e.preventDefault();
                gameState.isPaused = !gameState.isPaused;
                const pauseScreen = DOM.pauseScreen;
                if (pauseScreen) {
                    pauseScreen.classList.toggle('active');
                }
                playSound('pause');
            }

            if (e.key === 'Tab' && gameState.isRunning && !gameState.isPaused && !isMenuOpen && gameState.mice.length > 1) {
                e.preventDefault();
                gameState.selectedMouse = (gameState.selectedMouse + 1) % gameState.mice.length;
                let iterations = 0;
                while (!gameState.mice[gameState.selectedMouse].alive && iterations < gameState.mice.length) {
                    gameState.selectedMouse = (gameState.selectedMouse + 1) % gameState.mice.length;
                    iterations++;
                }
            }
        }, false);

        // ‚≠ê KEYUP - –ü–†–û–°–¢–û–ô: —É–¥–∞–ª–∏ –∫–ª—é—á –∏–∑ inputDesktop
        document.addEventListener('keyup', (e) => {
            const keyName = normalizeKeyName(e.key);
            // ‚úÖ –ì–õ–ê–í–ù–û–ï: –í–°–ï–ì–î–ê —É–¥–∞–ª—è–µ–º –∏–∑ inputDesktop
            inputDesktop.keys[keyName] = false;
        }, false);

        // ==================== –°–¢–ê–†–¢–ï–† ====================
        function startGame() {
            console.log('üéÆ START GAME - –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏–≥—Ä—ã...');
            try {
                // ‚≠ê v3.6.0: –ö–†–ò–¢–ò–ß–ï–°–ö–ò! –û—á–∏—â–∞–µ–º input –ø–µ—Ä–µ–¥ –Ω–∞—á–∞–ª–æ–º –∏–≥—Ä—ã
                clearAllInput();
                console.log('‚úÖ Input –æ—á–∏—â–µ–Ω');

                // –°–∫—Ä—ã–≤–∞–µ–º –º–µ–Ω—é –∏ –∑–∞–ø—É—Å–∫–∞–µ–º –∏–≥—Ä—É
                hideAllScreens();

                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏–≥—Ä—ã
                gameState.currentLevel = 1;
                gameState.score = 0;
                gameState.isRunning = true;
                gameState.isPaused = false;

                // ‚≠ê v3.6.0: –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º DOM –∫—ç—à –æ–¥–∏–Ω —Ä–∞–∑ (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è 60—Ö/—Å–µ–∫ –≤ updateUI)
                gameState.domCache.miceCount = DOM.miceCount;
                gameState.domCache.miceHP = DOM.miceHP;
                gameState.domCache.cheeseCount = DOM.cheeseCount;
                gameState.domCache.totalCheese = DOM.totalCheese;
                gameState.domCache.levelNumber = DOM.levelNumber;
                gameState.domCache.stamina = DOM.stamina;
                gameState.domCache.fps = DOM.fps;

                // ‚≠ê v3.6.0: –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º AudioContext –≤ user gesture context (click START GAME)
                console.log('üîä Initializing audio...');
                initAudio().then(() => {
                    console.log('üîä Audio ready, trying sound...');
                    playSound('button');
                }).catch(e => {
                    console.log('üîä Audio init note:', e);
                });

                // ‚≠ê v2.6.0: –ò—Å–ø–æ–ª—å–∑—É–µ–º –º–æ–±–∏–ª—å–Ω—ã–π –ø—É—Ç—å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤
                const isMobile = isMobileDevice();
                if (isMobile) {
                    console.log('üì± –ò—Å–ø–æ–ª—å–∑—É—é optimized mobile initialization...');
                    const success = initGameMobile();
                    if (!success) {
                        console.error('‚ùå Mobile initialization failed');
                        throw new Error('Mobile game initialization failed');
                    }
                } else {
                    console.log('üíª –ò—Å–ø–æ–ª—å–∑—É—é desktop initialization...');
                    initGame();
                    console.log('üéÆ initGame() –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ');
                }

                console.log('üéÆ –í—ã–∑–æ–≤ gameLoop()...');
                gameLoop();
                console.log('‚úÖ Game started —É—Å–ø–µ—à–Ω–æ! gameLoop –∑–∞–ø—É—â–µ–Ω');
            } catch (e) {
                console.error('‚ùå –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê –≤ startGame:');
                console.error('–°–æ–æ–±—â–µ–Ω–∏–µ:', e.message);
                console.error('–°—Ç–µ–∫:', e.stack);

                // ‚≠ê v2.6.0: –ù–∞ –º–æ–±–∏–ª–µ —Ä–∏—Å—É–µ–º –æ—à–∏–±–∫—É –Ω–∞ canvas, –Ω–µ alert()
                if (isMobileDevice()) {
                    drawErrorOnCanvas(`–û–®–ò–ë–ö–ê –ó–ê–ü–£–°–ö–ê:\n${e.message}`);
                } else {
                    alert('–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –∏–≥—Ä—ã:\n' + e.message);
                }
                gameState.isRunning = false;
            }
        }

        function nextLevel() {
            // ‚≠ê v3.6.0: –û—á–∏—â–∞–µ–º input –ø—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥–µ –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π —É—Ä–æ–≤–µ–Ω—å
            clearAllInput();

            // ‚≠ê v3.7.2: –ò—Å–ø–æ–ª—å–∑—É–µ–º hideAllScreens —á—Ç–æ–±—ã –ø—Ä–∞–≤–∏–ª—å–Ω–æ —É–ø—Ä–∞–≤–ª—è—Ç—å CSS –∫–ª–∞—Å—Å–∞–º–∏
            hideAllScreens();

            gameState.currentLevel++;
            gameState.isRunning = true;
            gameState.isPaused = false;
            playSound('button');

            try {
                initGame();
                gameLoop();
            } catch (e) {
                console.error('‚ùå –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê –≤ nextLevel:', e);
                gameState.isRunning = false;
                showScreen('gameOver');
            }
        }

        function resumeGame() {
            gameState.isPaused = false;
            // ‚≠ê v3.7.2: Use proper CSS class management instead of manual display
            DOM.pauseScreen.classList.remove('active');
            playSound('pause');
        }

        function menuGame() {
            gameState.isRunning = false;
            playSound('menu');
            showScreen('menu');
            DOM.playerName.value = '';
        }

        window.addEventListener('load', () => {
            // ‚≠ê v3.6.0: –ó–∞–≥—Ä—É–∂–∞–µ–º —Ä–µ–π—Ç–∏–Ω–≥ —Å GitHub –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
            getLeaderboard().then(leaderboard => {
                console.log(`‚úÖ –†–µ–π—Ç–∏–Ω–≥ –∑–∞–≥—Ä—É–∂–µ–Ω (${leaderboard.length} –∑–∞–ø–∏—Å–µ–π)`);
            }).catch(error => {
                console.warn(`‚ö†Ô∏è –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–µ–π—Ç–∏–Ω–≥–∞: ${error.message}`);
            });

            // Update version display
            const versionDisplay = DOM.versionDisplay;
            if (versionDisplay) {
                versionDisplay.textContent = GAME_VERSION;
            }

            console.log('üê≠ –ò–≥—Ä–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞ –∏ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–∞!');
            console.log(`üìå –í–µ—Ä—Å–∏—è: ${GAME_VERSION}`);
            console.log('‚úÖ –ó–∞—â–∏—Ç–∞ –æ—Ç –∑–∞–≤–∏—Å–∞–Ω–∏—è –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞');
            console.log('‚úÖ –°–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –≤–∫–ª—é—á–µ–Ω–æ');
            console.log('‚úÖ Cross-platform –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞');
            console.log('‚úÖ Emoji fallback —Å–∏—Å—Ç–µ–º–∞ –¥–ª—è Safari –≤–∫–ª—é—á–µ–Ω–∞');

            // Detect and setup for mobile/touch devices
            const isTouch = isTouchDevice();
            const isMobile = isMobileDevice();
            const isSafari = isIOSSafari();

            console.log('üì± –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ:', {
                touch: isTouch,
                mobile: isMobile,
                safari: isSafari,
                dpr: devicePixelRatio
            });

            if (isTouch || isMobile) {
                console.log('üì± –ú–û–ë–ò–õ–¨–ù–û–ï –£–°–¢–†–û–ô–°–¢–í–û - –í–∫–ª—é—á–∞–µ–º –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è');
                const virtualControls = DOM.virtualControls;
                if (virtualControls) {
                    console.log('‚úÖ –í–∏—Ä—Ç—É–∞–ª—å–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ –Ω–∞–π–¥–µ–Ω—ã –≤ DOM');
                    setupTouchControls();
                    console.log('‚úÖ Touch –∫–æ–Ω—Ç—Ä–æ–ª—ã –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã');
                } else {
                    console.error('‚ùå –í–∏—Ä—Ç—É–∞–ª—å–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ –ù–ï –Ω–∞–π–¥–µ–Ω—ã –≤ DOM!');
                }

                // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–¥—Å–∫–∞–∑–∫—É —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥–ª—è –º–æ–±–∏–ª—è
                const controlsHint = DOM.controls;
                if (controlsHint) {
                    controlsHint.textContent = 'üëÜ –ò—Å–ø–æ–ª—å–∑—É–π –∫–Ω–æ–ø–∫–∏ –≤–Ω–∏–∑—É —ç–∫—Ä–∞–Ω–∞ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è!';
                    console.log('‚úÖ –ü–æ–¥—Å–∫–∞–∑–∫–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∞');
                }

                // ‚≠ê –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û –î–õ–Ø –ú–û–ë–ò–õ–Ø: –û–ø—Ç–∏–º–∏–∑–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫–∏ –º–µ–Ω—é –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤
                setupMobileButtons();

                // ‚≠ê v3.6.0: –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –º–æ–±–∏–ª—å–Ω—É—é –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—é (unified event handlers)
                initMobileOptimization();
            }

            // iOS/Safari specific fixes
            if (isSafari) {
                console.log('üçé –ü—Ä–∏–º–µ–Ω–µ–Ω—ã Safari –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏');
                document.body.style.WebkitUserSelect = 'none';
                document.body.style.WebkitTouchCallout = 'none';
            }

            displayTip();

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω–æ–≤—ã–π —Å–æ–≤–µ—Ç –∫–∞–∂–¥—ã–µ 10 —Å–µ–∫—É–Ω–¥
            setInterval(() => {
                if (DOM.menuScreen.classList.contains('active')) {
                    displayTip();
                }
            }, 10000);

            // –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê: –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –≤—Å—ë –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ
            console.log('–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –∏–≥—Ä—ã:');
            console.log('- input.keys:', Object.keys(input.keys).length === 0 ? '‚úÖ –ß–∏—Å—Ç–æ' : '‚ö†Ô∏è –°–æ–¥–µ—Ä–∂–∏—Ç –¥–∞–Ω–Ω—ã–µ');
            console.log('- gameState.isRunning:', gameState.isRunning ? '–ó–∞–ø—É—â–µ–Ω–∞' : '‚úÖ –û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞');
            console.log('- gameLoopSafetyCounter:', gameLoopSafetyCounter);

            // ‚≠ê –û–¢–î–ï–õ–¨–ù–´–ô LOOP –î–õ–Ø –í–°–ï–• –≠–ö–†–ê–ù–û–í –ú–ï–ù–Æ (–º–µ–Ω—é, –ø–∞—É–∑–∞, —É—Ä–æ–≤–Ω–∏, game over, —Ä–µ–π—Ç–∏–Ω–≥) - —Ä–∞–±–æ—Ç–∞–µ—Ç –í–°–ï–ì–î–ê
            let lastGamepadMenuUpdate = 0;
            let lastGamepadXpress = 0;
            function controllerMenuLoop() {
                const now = performance.now();

                // –í—Å–µ–≥–¥–∞ –æ–±–Ω–æ–≤–ª—è–µ–º –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä –≤—Ö–æ–¥
                updateGamepadInput();

                const mergedInput = getMergedInput();
                const isMenuOpen = (DOM.menuScreen?.classList.contains('active')) === true;
                const isPauseOpen = (DOM.pauseScreen?.classList.contains('active')) === true;
                const isLevelCompleteOpen = (DOM.levelCompleteScreen?.classList.contains('active')) === true;
                const isGameOverOpen = (DOM.gameOverScreen?.classList.contains('active')) === true;
                const isLeaderboardOpen = (DOM.leaderboardScreen && DOM.leaderboardScreen.style.display !== 'none') === true;
                const isAnyScreenOpen = isMenuOpen || isPauseOpen || isLevelCompleteOpen || isGameOverOpen || isLeaderboardOpen;

                // ‚≠ê –û–ë–†–ê–ë–û–¢–ö–ê –≠–ö–†–ê–ù–û–í –° –ú–ï–ù–Æ (–≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é, –ø–∞—É–∑–∞, game over, —Ä–µ–π—Ç–∏–Ω–≥)
                if (isAnyScreenOpen && !gameState.isRunning) {
                    // –ù–∞–≤–∏–≥–∞—Ü–∏—è –º–µ–∂–¥—É –∫–Ω–æ–ø–∫–∞–º–∏ —Å debounce 150ms
                    if (now - lastGamepadMenuUpdate > 150) {
                        if (mergedInput.keys['ArrowUp']) {
                            console.log('üéÆ Menu UP - Gamepad');
                            highlightMenuButton(menuState.selectedButtonIndex - 1);
                            lastGamepadMenuUpdate = now;
                        } else if (mergedInput.keys['ArrowDown']) {
                            console.log('üéÆ Menu DOWN - Gamepad');
                            highlightMenuButton(menuState.selectedButtonIndex + 1);
                            lastGamepadMenuUpdate = now;
                        }
                    }

                    // X –∫–Ω–æ–ø–∫–∞ –¥–ª—è –Ω–∞–∂–∞—Ç–∏—è –∫–Ω–æ–ø–∫–∏ (—Å debounce 300ms)
                    if (now - lastGamepadXpress > 300) {
                        if (mergedInput.keys['Space']) {
                            console.log('üéÆ Menu/Screen CLICK - Gamepad');
                            const buttons = getVisibleMenuButtons();
                            if (buttons.length > 0) {
                                buttons[menuState.selectedButtonIndex].click();
                                playSound('button');
                            }
                            lastGamepadXpress = now;
                        }
                    }
                }

                // ‚≠ê –û–ë–†–ê–ë–û–¢–ö–ê –≠–ö–†–ê–ù–ê –ó–ê–í–ï–†–®–ï–ù–ò–Ø –£–†–û–í–ù–Ø (—Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π —Å–ª—É—á–∞–π - –ø—Ä—è–º–æ–π –ø–µ—Ä–µ—Ö–æ–¥)
                if (isLevelCompleteOpen && !gameState.isRunning) {
                    if (now - lastGamepadXpress > 300) {
                        if (mergedInput.keys['Space']) {
                            console.log('üéÆ Next Level - Gamepad X Button');
                            nextLevel();
                            playSound('button');
                            lastGamepadXpress = now;
                        }
                    }
                }

                requestAnimationFrame(controllerMenuLoop);
            }

            // –ó–∞–ø—É—Å–∫–∞–µ–º –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä –º–µ–Ω—é loop
            console.log('üéÆ –ó–∞–ø—É—Å–∫ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞ –¥–ª—è –≤—Å–µ—Ö —ç–∫—Ä–∞–Ω–æ–≤ –º–µ–Ω—é (–º–µ–Ω—é, –ø–∞—É–∑–∞, —É—Ä–æ–≤–Ω–∏, game over, —Ä–µ–π—Ç–∏–Ω–≥)...');
            controllerMenuLoop();
        });
    </script>
</body>
</html>
